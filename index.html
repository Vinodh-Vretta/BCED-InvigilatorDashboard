<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCED Invigilation Dashboard - Reskinned</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
        }
        .header-bar {
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
        }
        .main-content {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        .btn-primary {
            background-color: #2c5cc5;
            color: white;
            border-radius: 4px;
            padding: 8px 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #234a9e;
        }
        .btn-primary:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
            border-radius: 4px;
            padding: 8px 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
         .btn-secondary:hover {
            background-color: #d1d1d1;
        }
        .btn-danger {
            background-color: #fbe9e7;
            color: #c62828;
            border-radius: 4px;
            padding: 8px 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
             background-color: #ffcdd2;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }
        .status-dot.online { background-color: #4caf50; }
        .status-dot.offline { background-color: #d32f2f; }
        .status-dot.disconnected { background-color: #ffc107; } /* Yellow for Idle */
        .table-cell-border {
            border-right: 1px solid #e0e0e0;
        }
        .btn-unsubmit-active {
            background-color: #e0e0e0; /* Neutral grey */
            color: #333;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-unsubmit-active:hover {
            background-color: #d1d1d1;
        }
        .btn-unsubmit-disabled {
            background-color: #e0e0e0;
            color: #a0a0a0;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: not-allowed;
        }
        .status-blocked {
            background-color: #ffebee; /* Pale Red */
        }
        
        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .header-bar {
                justify-content: center;
                padding: 12px;
            }
            
            .main-content {
                margin: 0;
                border-radius: 0;
            }
            
            .p-6 {
                padding: 16px;
            }
            
            .filter-controls {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .filter-controls input,
            .filter-controls select {
                width: 100%;
                max-width: none;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 4px;
                white-space: nowrap;
            }
            
            .student-name-btn {
                font-size: 12px;
            }
            
            .unsubmit-btn,
            .unsubmit-btn-disabled {
                font-size: 11px;
                padding: 4px 8px;
            }
            
            /* Modal adjustments for mobile */
            .modal-content {
                margin: 16px;
                max-height: 90vh;
                overflow-y: auto;
            }
        }
        
        @media (max-width: 480px) {
            .header-bar {
                padding: 8px;
            }
            
            .p-6 {
                padding: 12px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            table {
                font-size: 11px;
            }
            
            th, td {
                padding: 6px 2px;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Login Page -->
    <div id="login-page">
        <div class="min-h-screen flex items-center justify-center bg-gray-100">
            <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">BCED Assessment Invigilation</h2>
                <form id="login-form">
                    <div class="space-y-6">
                        <div>
                            <label for="access-code" class="block text-sm font-medium text-gray-700">Invigilator Access Code</label>
                            <input type="text" id="access-code" name="access-code" value="PROCTOR-A1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <button type="submit" class="w-full btn-primary py-2">
                                Enter Session
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard Page (Initially Hidden) -->
    <div id="dashboard-page" class="hidden">
        <header class="header-bar px-6 py-3 flex justify-between items-center">
            <div>
                <button id="report-issue-btn" class="btn-danger flex items-center space-x-2">
                    <i class="fas fa-flag"></i>
                    <span>Report an Issue</span>
                </button>
            </div>
            <div class="flex items-center space-x-4">
                <button id="tech-support-btn" class="text-sm font-medium text-blue-600 hover:underline">Technical Support</button>
            </div>
        </header>

        <main class="p-6">
            <div class="main-content">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="text-2xl font-medium">Invigilation View</h1>
                            <p id="last-updated-timestamp" class="text-xs text-gray-500 mt-1">Last updated: ...</p>
                        </div>
                    </div>
                     <p class="text-sm text-gray-600 mt-4">
                        Number of students writing right now: <strong id="total-students-count" class="font-medium text-gray-800">0</strong>
                    </p>
                </div>
                
                <div class="p-6">
                     <div class="filter-controls flex justify-between items-center mb-4">
                        <input type="text" id="search-input" placeholder="Search by Student Name or PEN" class="px-3 py-2 border border-gray-300 rounded-md w-full max-w-xs focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <div class="flex items-center space-x-4">
                             <div>
                                <label for="component-filter" class="text-sm font-medium text-gray-700 mr-2">Component:</label>
                                <select id="component-filter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                                    <option value="all">All Components</option>
                                    <option value="NME 10">NME 10</option>
                                    <option value="LTE10">LTE10</option>
                                    <option value="LTF12 (ORAL)">LTF12 (ORAL)</option>
                                    <option value="LTF12 (WRITTEN)">LTF12 (WRITTEN)</option>
                                    <option value="LTP10 (ORAL)">LTP10 (ORAL)</option>
                                    <option value="LTP10 (WRITTEN)">LTP10 (WRITTEN)</option>
                                    <option value="LTP12 (ORAL)">LTP12 (ORAL)</option>
                                    <option value="LTP12 (WRITTEN)">LTP12 (WRITTEN)</option>
                                </select>
                            </div>
                            <div>
                                <label for="status-filter" class="text-sm font-medium text-gray-700 mr-2">Status:</label>
                                <select id="status-filter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                                    <option value="all">All Statuses</option>
                                    <option value="Not Started">Not Started</option>
                                    <option value="Ready to Start">Ready to Start</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Submitted">Submitted</option>
                                    <option value="Blocked">Blocked</option>
                                    <option value="Awaiting Ministerial Decision">Awaiting Ministerial Decision</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                    <table class="w-full text-sm text-left table-fixed">
                        <thead class="border-b-2 border-gray-300">
                            <tr>
                                <th class="py-2 px-3 w-24 font-medium text-gray-700">Watch</th>
                                <th scope="col" class="py-2 px-3 font-medium text-gray-700 w-[15%]">PEN</th>
                                <th scope="col" class="py-2 px-3 font-medium text-blue-700 w-[40%]">
                                    <button id="sort-by-name-btn" class="w-full text-left">First Name / Last Name <span id="sort-indicator">◆</span></button>
                                </th>
                                <th scope="col" class="py-2 px-3 font-medium text-gray-700 w-[20%]">Component</th>
                                <th scope="col" class="py-2 px-3 font-medium text-gray-700 w-[25%]">Status</th>
                            </tr>
                        </thead>
                        <tbody id="student-table-body">
                            <!-- Student rows will be injected here by JavaScript -->
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="unsubmit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Request to Unsubmit Assessment</h3>
            <form id="unsubmit-request-form">
                <p class="text-sm text-gray-600 mb-4">For: <strong id="student-name-modal"></strong></p>
                
                <div class="mb-4">
                    <label for="invigilator-email" class="block text-sm font-medium text-gray-700">Your Email for Notification</label>
                    <input type="email" id="invigilator-email" name="invigilator-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                </div>

                <div class="mb-4">
                    <label for="unsubmit-reason" class="block text-sm font-medium text-gray-700">Reason for Request</label>
                    <select id="unsubmit-reason" name="unsubmit-reason" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Accidental Submission">Accidental Submission</option>
                        <option>Technical Issue</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div id="other-reason-container" class="mb-4 hidden">
                    <label for="other-reason-text" class="block text-sm font-medium text-gray-700">Please specify</label>
                    <textarea id="other-reason-text" name="other-reason-text" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                
                <div class="flex justify-end space-x-4">
                    <button id="cancel-unsubmit" type="button" class="btn-secondary">Cancel</button>
                    <button id="submit-request-btn" type="submit" class="btn-primary">Submit Request</button>
                </div>
            </form>
        </div>
    </div>
    <div id="tech-support-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl p-8 w-full max-w-lg mx-4">
            <h3 class="text-xl font-medium text-gray-900 mb-4">Information centre hours:</h3>
            <p class="text-lg text-gray-700 mb-6">
                <strong class="font-semibold">Monday to Friday:</strong><br>
                8:00 a.m. to 5:00 p.m. (EST)
            </p>
            <div class="border rounded-md overflow-hidden">
                <table class="w-full">
                    <tbody>
                        <tr class="border-b">
                            <td class="p-3 font-medium bg-gray-50 w-1/3">Email</td>
                            <td class="p-3 text-blue-600 font-medium">bced-support@vretta.com</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-medium bg-gray-50 w-1/3">Phone Number</td>
                            <td class="p-3 font-medium">1-888-887-3882</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-6 text-center">
                <button id="dismiss-support-modal" class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-2 px-6 rounded-md">
                    Dismiss Notification
                </button>
            </div>
        </div>
    </div>
    <div id="student-info-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
            <div class="p-4 border-b">
                <h2 id="student-info-title" class="text-xl font-semibold text-gray-800">Student Info</h2>
            </div>
            <div id="student-info-content" class="p-6">
                <!-- Content will be dynamically generated here -->
            </div>
            <div class="p-4 bg-gray-50 text-right border-t">
                 <button id="ok-student-info-modal" class="btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- Report an Issue Modals -->
    <div id="report-issue-info-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Report an Issue</h3>
            <p class="text-sm text-gray-600 mb-4">During the assessment, school administrators and teachers must report issues to BCED that may affect the security, validity, or reliability of the assessment.</p>
            
            <div class="mb-4 p-4 border-l-4 border-blue-500 bg-blue-50">
                <h4 class="font-bold text-blue-800">Time-sensitive Issues Requiring Technical Support</h4>
                <p class="text-sm text-blue-700 mt-1">If the issue requires support to allow the student to start or continue the assessment, please report it here under the <strong>Technical Issue / Device Issue</strong> category or phone <strong>1-888-887-3882</strong> for assistance. Issues reported in the <strong>Technical Issue / Device Issue</strong> category will automatically be forwarded to the technical support team for immediate follow-up.</p>
            </div>

            <div class="mb-6 p-4 border-l-4 border-yellow-500 bg-yellow-50">
                <h4 class="font-bold text-yellow-800">Issues NOT Requiring Immediate Technical Support</h4>
                <p class="text-sm text-yellow-700 mt-1">If the issue does not require immediate support (e.g., the student has already completed the assessment or can continue despite the issue) but may affect the student's results or security of the test, report it under <strong>Problem with the Assessment</strong> or <strong>Administration Anomaly or Academic Dishonesty</strong>. Issues that are not time-sensitive will be reviewed by BCED at the end of the assessment window.</p>
            </div>

            <div class="flex justify-end space-x-4">
                <button id="cancel-report-issue-info" type="button" class="btn-secondary">Cancel</button>
                <button id="ok-report-issue-info" type="button" class="btn-primary">OK</button>
            </div>
        </div>
    </div>

    <div id="report-issue-form-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Report an Issue</h3>
            <form id="report-issue-form">
                <div class="mb-4">
                    <label for="issue-category" class="block text-sm font-medium text-gray-700">Reported Issue Category:*</label>
                    <select id="issue-category" name="issue-category" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required>
                        <option value="" disabled selected>Select a category</option>
                        <option>Technical Issue / Device Issue</option>
                        <option>Problem with the Assessment</option>
                        <option>Administration Anomaly or Academic Dishonesty</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="issue-assessment" class="block text-sm font-medium text-gray-700">Assessment(s):*</label>
                    <select id="issue-assessment" name="issue-assessment" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required>
                        <option value="" disabled selected>Select an assessment</option>
                        <option>NME 10</option>
                        <option>LTE10</option>
                        <option>LTF12 (ORAL)</option>
                        <option>LTF12 (WRITTEN)</option>
                        <option>LTP10 (ORAL)</option>
                        <option>LTP10 (WRITTEN)</option>
                        <option>LTP12 (ORAL)</option>
                        <option>LTP12 (WRITTEN)</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="issue-description" class="block text-sm font-medium text-gray-700">Report Issue:*</label>
                    <textarea id="issue-description" name="issue-description" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Students:*</label>
                    <div id="report-issue-student-list" class="mt-2 border rounded-md h-48 overflow-y-auto p-2">
                        <!-- Student list will be populated here -->
                    </div>
                </div>

                <div class="flex justify-end space-x-4">
                    <button id="cancel-report-issue-form" type="button" class="btn-secondary">Cancel</button>
                    <button id="submit-issue-report-btn" type="submit" class="btn-primary" disabled>Report</button>
                </div>
            </form>
        </div>
    </div>

    <div id="unblock-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Unblock Student</h3>
            <p class="text-sm text-gray-600 mb-2">For: <strong id="unblock-student-name"></strong></p>
            <p class="text-sm text-gray-600 mb-4">Violation: <strong id="unblock-violation-reason"></strong></p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-unblock" type="button" class="btn-secondary">Cancel</button>
                <button id="confirm-unblock" type="button" class="btn-primary">Unblock</button>
            </div>
        </div>
    </div>


<script>
    // --- MOCK DATA ---
    const initialStudents = [
        { id: '1', pen: '123456789', firstName: 'Emma', lastName: 'Thompson', component: 'NME 10', watched: true, connectionStatus: 'online', status: 'In Progress', stage: 1, question: 3, time: 429566, lastSeen: null, loginTime: new Date().getTime() - (1 * 60 * 60 * 1000), submissionTime: null, violationReason: null },
        { id: '2', pen: '987654321', firstName: 'Michael', lastName: 'Chen', component: 'NME 10', watched: false, connectionStatus: 'offline', status: 'Submitted', stage: null, question: null, time: 8946, lastSeen: new Date().getTime() - 300000, startTime: new Date().getTime() - (2 * 60 * 60 * 1000), loginTime: new Date().getTime() - (2 * 60 * 60 * 1000), submissionTime: new Date().getTime() - (1.5 * 60 * 60 * 1000), violationReason: null }, 
        { id: '3', pen: '456789123', firstName: 'Sarah', lastName: 'Johnson', component: 'LTE10', watched: false, connectionStatus: 'online', status: 'Submitted', stage: null, question: null, time: 394, lastSeen: null, startTime: new Date().getTime() - (4 * 60 * 60 * 1000), loginTime: new Date().getTime() - (4 * 60 * 60 * 1000), submissionTime: new Date().getTime() - (3 * 60 * 60 * 1000), violationReason: null }, 
        { id: '4', pen: '789123456', firstName: 'David', lastName: 'Rodriguez', component: 'LTE10', watched: true, connectionStatus: 'Idle', status: 'In Progress', stage: 2, question: 5, time: 0, lastSeen: new Date().getTime() - 60000, loginTime: new Date().getTime() - (1 * 60 * 60 * 1000), submissionTime: null, violationReason: null },
        { id: '5', pen: '321654987', firstName: 'Jessica', lastName: 'Wu', component: 'NME 10', watched: false, connectionStatus: 'online', status: 'Submitted', stage: null, question: null, time: 0, lastSeen: null, startTime: new Date().getTime() - (1 * 60 * 60 * 1000), loginTime: new Date().getTime() - (1 * 60 * 60 * 1000), submissionTime: new Date().getTime() - (30 * 60 * 1000), violationReason: null }, 
        { id: '6', pen: '234567890', firstName: 'Amanda', lastName: 'Singh', component: 'LTE10', watched: false, connectionStatus: 'online', status: 'Not Started', stage: null, question: null, time: 0, lastSeen: null, loginTime: null, submissionTime: null, violationReason: null },
        { id: '7', pen: '345678901', firstName: 'James', lastName: 'Wilson', component: 'NME 10', watched: false, connectionStatus: 'offline', status: 'Ready to Start', stage: null, question: null, time: 0, lastSeen: new Date().getTime() - 86400000, loginTime: null, submissionTime: null, violationReason: null },
        { id: '8', pen: '567890123', firstName: 'Olivia', lastName: 'Martinez', component: 'NME 10', watched: false, connectionStatus: 'online', status: 'In Progress', stage: 3, question: 7, time: 1245, lastSeen: null, loginTime: new Date().getTime() - (1 * 60 * 60 * 1000), submissionTime: null, violationReason: null },
        { id: '9', pen: '678901234', firstName: 'Ethan', lastName: 'Brown', component: 'LTE10', watched: true, connectionStatus: 'Idle', status: 'In Progress', stage: 1, question: 2, time: 567, lastSeen: new Date().getTime() - 120000, loginTime: new Date().getTime() - (1 * 60 * 60 * 1000), submissionTime: null, violationReason: null },
        { id: '10', pen: '789012345', firstName: 'Sophia', lastName: 'Davis', component: 'NME 10', watched: false, connectionStatus: 'offline', status: 'Submitted', stage: null, question: null, time: 2134, lastSeen: new Date().getTime() - 1800000, startTime: new Date().getTime() - (30 * 60 * 1000), loginTime: new Date().getTime() - (30 * 60 * 1000), submissionTime: new Date().getTime() - (15 * 60 * 1000), violationReason: null }, 
        { id: '11', pen: '890123456', firstName: 'Liam', lastName: 'Miller', component: 'LTE10', watched: false, connectionStatus: 'online', status: 'Ready to Start', stage: null, question: null, time: 0, lastSeen: null, loginTime: null, submissionTime: null, violationReason: null },
        { id: '12', pen: '901234567', firstName: 'Ava', lastName: 'Wilson', component: 'NME 10', watched: false, connectionStatus: 'online', status: 'In Progress', stage: 2, question: 4, time: 892, lastSeen: null, loginTime: new Date().getTime() - (1 * 60 * 60 * 1000), submissionTime: null, violationReason: null },
        { id: '13', pen: '012345678', firstName: 'Noah', lastName: 'Moore', component: 'LTE10', watched: false, connectionStatus: 'Idle', status: 'Not Started', stage: null, question: null, time: 0, lastSeen: new Date().getTime() - 900000, loginTime: null, submissionTime: null, violationReason: null },
        { id: '14', pen: '123450789', firstName: 'Isabella', lastName: 'Taylor', component: 'NME 10', watched: true, connectionStatus: 'online', status: 'Submitted', stage: null, question: null, time: 1567, lastSeen: null, startTime: new Date().getTime() - (5 * 60 * 60 * 1000), loginTime: new Date().getTime() - (5 * 60 * 60 * 1000), submissionTime: new Date().getTime() - (4 * 60 * 60 * 1000), violationReason: null }, 
        { id: '15', pen: '234561890', firstName: 'Mason', lastName: 'Anderson', component: 'LTE10', watched: false, connectionStatus: 'offline', status: 'In Progress', stage: 1, question: 1, time: 234, lastSeen: new Date().getTime() - 600000, loginTime: new Date().getTime() - (1 * 60 * 60 * 1000), submissionTime: null, violationReason: null },
        { id: '16', pen: '345672901', firstName: 'Mia', lastName: 'Thomas', component: 'NME 10', watched: false, connectionStatus: 'online', status: 'Ready to Start', stage: null, question: null, time: 0, lastSeen: null, loginTime: null, submissionTime: null, violationReason: null },
        { id: '17', pen: '456783012', firstName: 'Lucas', lastName: 'Jackson', component: 'LTE10', watched: false, connectionStatus: 'online', status: 'In Progress', stage: 4, question: 9, time: 1789, lastSeen: null, loginTime: new Date().getTime() - (1 * 60 * 60 * 1000), submissionTime: null, violationReason: null },
        { id: '18', pen: '567894123', firstName: 'Charlotte', lastName: 'White', component: 'NME 10', watched: false, connectionStatus: 'Idle', status: 'Awaiting Ministerial Decision', stage: null, question: null, time: 1456, lastSeen: new Date().getTime() - 240000, startTime: new Date().getTime() - (90 * 60 * 1000), loginTime: new Date().getTime() - (90 * 60 * 1000), submissionTime: new Date().getTime() - (80 * 60 * 1000), violationReason: null }, 
        { id: '19', pen: '678905234', firstName: 'Benjamin', lastName: 'Harris', component: 'LTE10', watched: true, connectionStatus: 'offline', status: 'Not Started', stage: null, question: null, time: 0, lastSeen: new Date().getTime() - 3600000, loginTime: null, submissionTime: null, violationReason: null },
        { id: '20', pen: '789016345', firstName: 'Amelia', lastName: 'Martin', component: 'NME 10', watched: false, connectionStatus: 'online', status: 'In Progress', stage: 2, question: 6, time: 678, lastSeen: null, loginTime: new Date().getTime() - (1 * 60 * 60 * 1000), submissionTime: null, violationReason: null },
        { id: '21', pen: '890127456', firstName: 'Alexander', lastName: 'Garcia', component: 'LTE10', watched: false, connectionStatus: 'online', status: 'Awaiting Ministerial Decision', stage: null, question: null, time: 2345, lastSeen: null, startTime: new Date().getTime() - (2 * 60 * 60 * 1000), loginTime: new Date().getTime() - (2 * 60 * 60 * 1000), submissionTime: new Date().getTime() - (1.5 * 60 * 60 * 1000), violationReason: null }, 
        { id: '22', pen: '901238567', firstName: 'Harper', lastName: 'Rodriguez', component: 'NME 10', watched: false, connectionStatus: 'Idle', status: 'Ready to Start', stage: null, question: null, time: 0, lastSeen: new Date().getTime() - 180000, loginTime: null, submissionTime: null, violationReason: null },
        { id: '23', pen: '012349678', firstName: 'William', lastName: 'Lewis', component: 'LTE10', watched: false, connectionStatus: 'offline', status: 'In Progress', stage: 3, question: 8, time: 1123, lastSeen: new Date().getTime() - 420000, loginTime: new Date().getTime() - (1 * 60 * 60 * 1000), submissionTime: null, violationReason: null },
        { id: '24', pen: '123460789', firstName: 'Evelyn', lastName: 'Lee', component: 'NME 10', watched: false, connectionStatus: 'online', status: 'Not Started', stage: null, question: null, time: 0, lastSeen: null, loginTime: null, submissionTime: null, violationReason: null },
        { id: '25', pen: '234571890', firstName: 'Henry', lastName: 'Walker', component: 'LTE10', watched: false, connectionStatus: 'online', status: 'Awaiting Ministerial Decision', stage: null, question: null, time: 1890, lastSeen: null, startTime: new Date().getTime() - (6 * 60 * 60 * 1000), loginTime: new Date().getTime() - (6 * 60 * 60 * 1000), submissionTime: new Date().getTime() - (5 * 60 * 60 * 1000), violationReason: null }, 
        { id: '26', pen: '345682901', firstName: 'Abigail', lastName: 'Hall', component: 'NME 10', watched: true, connectionStatus: 'Idle', status: 'In Progress', stage: 1, question: 4, time: 445, lastSeen: new Date().getTime() - 90000, loginTime: new Date().getTime() - (1 * 60 * 60 * 1000), submissionTime: null, violationReason: null },
        { id: '27', pen: '456793012', firstName: 'Sebastian', lastName: 'Allen', component: 'LTE10', watched: false, connectionStatus: 'offline', status: 'Ready to Start', stage: null, question: null, time: 0, lastSeen: new Date().getTime() - 1200000, loginTime: null, submissionTime: null, violationReason: null },
        { id: '28', pen: '567804123', firstName: 'Grace', lastName: 'Young', component: 'LTF12 (ORAL)', watched: false, connectionStatus: 'online', status: 'In Progress', stage: 2, question: 5, time: 567, lastSeen: null, loginTime: new Date().getTime() - (1 * 60 * 60 * 1000), submissionTime: null, violationReason: null },
        { id: '29', pen: '678915234', firstName: 'Jack', lastName: 'King', component: 'LTP10 (ORAL)', watched: false, connectionStatus: 'Idle', status: 'Submitted', stage: null, question: null, time: 1234, lastSeen: new Date().getTime() - 180000, startTime: new Date().getTime() - (2 * 60 * 60 * 1000), loginTime: new Date().getTime() - (2 * 60 * 60 * 1000), submissionTime: new Date().getTime() - (1 * 60 * 60 * 1000), violationReason: null },
        { id: '30', pen: '789026345', firstName: 'Lily', lastName: 'Wright', component: 'LTP12 (ORAL)', watched: false, connectionStatus: 'online', status: 'Ready to Start', stage: null, question: null, time: 0, lastSeen: null, loginTime: null, submissionTime: null, violationReason: null },
        { id: '33', pen: '135792468', firstName: 'Chloe', lastName: 'Scott', component: 'LTF12 (WRITTEN)', watched: false, connectionStatus: 'online', status: 'In Progress', stage: 1, question: 1, time: 150, lastSeen: null, loginTime: new Date().getTime() - (1 * 60 * 60 * 1000), submissionTime: null, violationReason: null },
        { id: '34', pen: '246813579', firstName: 'Ryan', lastName: 'Green', component: 'LTP10 (WRITTEN)', watched: false, connectionStatus: 'online', status: 'Not Started', stage: null, question: null, time: 0, lastSeen: null, loginTime: null, submissionTime: null, violationReason: null },
        { id: '35', pen: '975318642', firstName: 'Madison', lastName: 'Adams', component: 'LTP12 (WRITTEN)', watched: false, connectionStatus: 'offline', status: 'Ready to Start', stage: null, question: null, time: 0, lastSeen: new Date().getTime() - 7200000, loginTime: null, submissionTime: null, violationReason: null },
        { id: '36', pen: '112233445', firstName: 'Daniel', lastName: 'Lee', component: 'NME 10', watched: false, connectionStatus: 'online', status: 'Blocked', stage: 2, question: 8, time: 1500, lastSeen: null, loginTime: new Date().getTime() - (20 * 60 * 1000), submissionTime: null, violationReason: 'Student attempted to exit the assessment.' },
        { id: '37', pen: '223344556', firstName: 'Sophie', lastName: 'Clark', component: 'LTE10', watched: false, connectionStatus: 'online', status: 'Blocked', stage: 1, question: 2, time: 800, lastSeen: null, loginTime: new Date().getTime() - (10 * 60 * 1000), submissionTime: null, violationReason: 'Student opened a new tab.' },
        { id: '38', pen: '334455667', firstName: 'Logan', lastName: 'Hall', component: 'LTF12 (ORAL)', watched: false, connectionStatus: 'online', status: 'Blocked', stage: 3, question: 5, time: 2200, lastSeen: null, loginTime: new Date().getTime() - (35 * 60 * 1000), submissionTime: null, violationReason: 'Student attempted to use a forbidden application.' }
    ];
    
    let students = [...initialStudents];
    let sortDirection = 'none';

    // --- DOM ELEMENTS ---
    const loginPage = document.getElementById('login-page');
    const dashboardPage = document.getElementById('dashboard-page');
    const loginForm = document.getElementById('login-form');
    const lastUpdatedTimestamp = document.getElementById('last-updated-timestamp');
    const totalStudentsCount = document.getElementById('total-students-count');
    const tableBody = document.getElementById('student-table-body');
    const searchInput = document.getElementById('search-input');
    const statusFilter = document.getElementById('status-filter');
    const componentFilter = document.getElementById('component-filter');
    const sortByNameBtn = document.getElementById('sort-by-name-btn');
    const sortIndicator = document.getElementById('sort-indicator');
    const unsubmitModal = document.getElementById('unsubmit-modal');
    const unsubmitRequestForm = document.getElementById('unsubmit-request-form');
    const studentNameUnsubmitModal = document.getElementById('student-name-modal');
    const cancelUnsubmitBtn = document.getElementById('cancel-unsubmit');
    const submitRequestBtn = document.getElementById('submit-request-btn');
    const unsubmitReason = document.getElementById('unsubmit-reason');
    const otherReasonContainer = document.getElementById('other-reason-container');
    const otherReasonText = document.getElementById('other-reason-text');
    
    const techSupportBtn = document.getElementById('tech-support-btn');
    const techSupportModal = document.getElementById('tech-support-modal');
    const dismissSupportModalBtn = document.getElementById('dismiss-support-modal');
    
    const studentInfoModal = document.getElementById('student-info-modal');
    const studentInfoTitle = document.getElementById('student-info-title');
    const studentInfoContent = document.getElementById('student-info-content');
    const okStudentInfoBtn = document.getElementById('ok-student-info-modal');

    const reportIssueBtn = document.getElementById('report-issue-btn');
    const reportIssueInfoModal = document.getElementById('report-issue-info-modal');
    const cancelReportIssueInfoBtn = document.getElementById('cancel-report-issue-info');
    const okReportIssueInfoBtn = document.getElementById('ok-report-issue-info');
    const reportIssueFormModal = document.getElementById('report-issue-form-modal');
    const reportIssueForm = document.getElementById('report-issue-form');
    const cancelReportIssueFormBtn = document.getElementById('cancel-report-issue-form');
    const submitIssueReportBtn = document.getElementById('submit-issue-report-btn');
    const issueCategory = document.getElementById('issue-category');
    const issueDescription = document.getElementById('issue-description');
    const reportIssueStudentList = document.getElementById('report-issue-student-list');

    const unblockModal = document.getElementById('unblock-modal');
    const unblockStudentName = document.getElementById('unblock-student-name');
    const unblockViolationReason = document.getElementById('unblock-violation-reason');
    const cancelUnblockBtn = document.getElementById('cancel-unblock');
    const confirmUnblockBtn = document.getElementById('confirm-unblock');
    
    // --- FUNCTIONS ---
    function renderTable(studentData) {
        tableBody.innerHTML = '';
        totalStudentsCount.textContent = studentData.filter(s => s.connectionStatus === 'online').length;
        lastUpdatedTimestamp.textContent = `Last updated: ${new Date().toLocaleTimeString('en-US', { timeZone: 'America/Vancouver' })}`;

        if (studentData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-500">No students found.</td></tr>`;
            return;
        }

        studentData.forEach(student => {
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200 hover:bg-gray-50';
            
            let connectionStatusClass = 'offline';
            if (student.connectionStatus === 'online') connectionStatusClass = 'online';
            if (student.connectionStatus === 'Idle') connectionStatusClass = 'disconnected';
            
            let statusContent = '';
            if (student.status === 'Submitted') {
                const after4PM = isAfter4PM();
                const timeLimitExceeded = !isUnsubmitAllowed(student.startTime) && !after4PM;
                let buttonHtml;

                if (!after4PM && !timeLimitExceeded) {
                    buttonHtml = `<button class="unsubmit-btn btn-unsubmit-active ml-4" data-student-id="${student.id}" data-student-name="${student.firstName} ${student.lastName}">Unsubmit</button>`;
                } else {
                    let tooltipMessage = '';
                    if (after4PM) {
                        tooltipMessage = `Unsubmit is unavailable after 4 PM. Contact support:<br>Phone: 1-888-887-3882`;
                    } else { // timeLimitExceeded
                        tooltipMessage = `3-hour window expired. Contact support for unsubmission:<br>Email: bced-support@vretta.com<br>Phone: 1-888-887-3882`;
                    }
                    buttonHtml = `<div class="relative">
                                    <button class="btn-unsubmit-disabled ml-4" disabled>Unsubmit</button>
                                    <div class="unsubmit-tooltip hidden absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-md whitespace-nowrap z-10">
                                        ${tooltipMessage}
                                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                                    </div>
                                  </div>`;
                }
                
                statusContent = `<div class="flex items-center">
                                    <p class="font-medium text-gray-700">Submitted</p>
                                    ${buttonHtml}
                                 </div>`;
            } else if (student.status === 'Blocked') {
                 statusContent = `<div class="flex items-center">
                                    <p class="font-medium text-red-600">Blocked</p>
                                    <button class="unblock-btn btn-unsubmit-active ml-4" data-student-id="${student.id}">Unblock</button>
                                 </div>`;
            } else if (student.status === 'In Progress') {
                statusContent = `<div>
                                    <p class="font-medium">In Progress</p>
                                    <p class="text-xs text-gray-500">${student.time} minute(s)</p>
                                 </div>`;
            } else {
                statusContent = `<p class="font-medium text-gray-700">${student.status}</p>`;
            }

            let statusBgClass = '';
            if (student.status === 'Ready to Start') statusBgClass = 'bg-[#fff3e0]';
            else if (student.status === 'Not Started') statusBgClass = 'bg-gray-100';
            else if (student.status === 'Blocked') statusBgClass = 'status-blocked';

            let lastSeenHtml = '';
            if (student.connectionStatus !== 'online' && student.lastSeen) {
                lastSeenHtml = `<span class="ml-1 text-gray-500">(Last seen: ${new Date(student.lastSeen).toLocaleTimeString('en-US', {timeZone: 'America/Vancouver'})})</span>`;
            }

            row.innerHTML = `
                <td class="py-3 px-3 table-cell-border text-center">
                    <input type="checkbox" class="watch-checkbox" data-student-id="${student.id}" ${student.watched ? 'checked' : ''}>
                </td>
                <td class="py-3 px-3 table-cell-border">${student.pen}</td>
                <td class="py-3 px-3 table-cell-border">
                    <div class="flex items-center space-x-2">
                        <button class="student-name-btn text-blue-700 font-medium hover:underline truncate" data-student-id="${student.id}">${student.firstName} ${student.lastName}</button>
                        <div class="text-xs text-gray-700 flex items-center flex-shrink-0">
                            <span class="status-dot ${connectionStatusClass}"></span>
                            <span>${student.connectionStatus === 'online' ? 'Writing' : student.connectionStatus.charAt(0).toUpperCase() + student.connectionStatus.slice(1)}</span>
                            ${lastSeenHtml}
                        </div>
                    </div>
                </td>
                <td class="py-3 px-3 table-cell-border">
                    <span class="text-sm font-medium text-gray-700">${student.component}</span>
                </td>
                <td class="py-3 px-3 ${statusBgClass}">${statusContent}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    function updateView() {
        let displayedStudents = [...students];

        // Apply filters
        const selectedStatus = statusFilter.value;
        const selectedComponent = componentFilter.value;
        if (selectedStatus !== 'all') {
            displayedStudents = displayedStudents.filter(s => s.status === selectedStatus);
        }
        if (selectedComponent !== 'all') {
            displayedStudents = displayedStudents.filter(s => s.component === selectedComponent);
        }

        const searchTerm = searchInput.value.toLowerCase();
        if (searchTerm) {
            displayedStudents = displayedStudents.filter(student => 
                `${student.firstName} ${student.lastName}`.toLowerCase().includes(searchTerm) || 
                student.pen.toLowerCase().includes(searchTerm)
            );
        }

        // Apply sorting
        displayedStudents.sort((a, b) => {
            // 0. Pinned students first
            if (a.watched && !b.watched) return -1;
            if (!a.watched && b.watched) return 1;

            // 1. Primary sort: Online students first
            const isOnlineA = a.connectionStatus === 'online';
            const isOnlineB = b.connectionStatus === 'online';
            if (isOnlineA !== isOnlineB) {
                return isOnlineA ? -1 : 1;
            }

            // 2. Secondary sort: Status (alphabetical)
            const statusComparison = a.status.localeCompare(b.status);
            if (statusComparison !== 0) {
                return statusComparison;
            }

            // 3. Tertiary sort: Name (alphabetical, respects sortDirection)
            const nameA = `${a.firstName} ${a.lastName}`.toLowerCase();
            const nameB = `${b.firstName} ${b.lastName}`.toLowerCase();
            const nameComparison = nameA.localeCompare(nameB);
            
            if (sortDirection !== 'none') {
                 if (nameComparison !== 0) {
                    return sortDirection === 'asc' ? nameComparison : -nameComparison;
                 }
            } else {
                // Default alphabetical sort for name if no direction is set
                if (nameComparison !== 0) {
                    return nameComparison;
                }
            }

            // 4. Quaternary sort: Component (alphabetical)
            return a.component.localeCompare(b.component);
        });
        
        renderTable(displayedStudents);
    }
    
    function isAfter4PM() {
        const now = new Date();
        const localTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Vancouver' }));
        return localTime.getHours() >= 16;
    }

    function isUnsubmitAllowed(startTime) {
        if (!startTime) return true; 
        const threeHoursInMs = 3 * 60 * 60 * 1000;
        const currentTime = new Date().getTime();
        return (currentTime - startTime) < threeHoursInMs;
    }
    
    function openUnsubmitModal(studentId, studentName) {
        const student = students.find(s => s.id === studentId);
        if (!student) return;

        studentNameUnsubmitModal.textContent = studentName;
        unsubmitRequestForm.dataset.studentId = studentId;

        const accidentalSubmissionOption = unsubmitReason.querySelector('option[value="Accidental Submission"]');
        if (isAutoApprovalAllowed(student.submissionTime)) {
            accidentalSubmissionOption.disabled = false;
        } else {
            accidentalSubmissionOption.disabled = true;
        }

        unsubmitModal.classList.remove('hidden');
        validateUnsubmitRequestForm();
    }

    function closeUnsubmitModal() {
        unsubmitModal.classList.add('hidden');
        unsubmitRequestForm.reset();
        otherReasonContainer.classList.add('hidden');
    }

    function isAutoApprovalAllowed(submissionTime) {
        if (!submissionTime) return false;
        const oneHourInMs = 60 * 60 * 1000;
        const currentTime = new Date().getTime();
        return (currentTime - submissionTime) < oneHourInMs;
    }

    function handleUnsubmitRequest(e) {
        e.preventDefault();
        const studentId = unsubmitRequestForm.dataset.studentId;
        const studentIndex = students.findIndex(s => s.id === studentId);
        if (studentIndex > -1) {
            const student = students[studentIndex];
            if (isAutoApprovalAllowed(student.submissionTime)) {
                student.status = 'In Progress';
                console.log(`Unsubmission for ${student.firstName} ${student.lastName} auto-approved.`);
            } else {
                student.status = 'Awaiting Ministerial Decision';
                console.log(`Unsubmission request for ${student.firstName} ${student.lastName} sent for approval.`);
            }
        }
        updateView();
        closeUnsubmitModal();
    }
    
    function openUnblockModal(studentId) {
        const student = students.find(s => s.id === studentId);
        if (student) {
            unblockStudentName.textContent = `${student.firstName} ${student.lastName}`;
            unblockViolationReason.textContent = student.violationReason;
            confirmUnblockBtn.dataset.studentId = studentId;
            unblockModal.classList.remove('hidden');
        }
    }

    function closeUnblockModal() {
        unblockModal.classList.add('hidden');
    }
    
    function handleUnblock() {
        const studentId = confirmUnblockBtn.dataset.studentId;
        const studentIndex = students.findIndex(s => s.id === studentId);
        if (studentIndex > -1) {
            students[studentIndex].status = 'In Progress';
        }
        updateView();
        closeUnblockModal();
        closeStudentInfoModal();
    }
    
    function validateUnsubmitRequestForm() {
        const reason = unsubmitReason.value;
        const otherText = otherReasonText.value.trim();
        if (reason === 'other' && otherText === '') {
            submitRequestBtn.disabled = true;
        } else {
            submitRequestBtn.disabled = false;
        }
    }

    function populateReportIssueStudentList() {
        reportIssueStudentList.innerHTML = '';
        students.forEach(student => {
            const studentDiv = document.createElement('div');
            studentDiv.className = 'flex items-center p-1';
            studentDiv.innerHTML = `
                <input type="checkbox" id="student-${student.id}" name="students" value="${student.id}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                <label for="student-${student.id}" class="ml-3 text-sm text-gray-700">${student.firstName} ${student.lastName}</label>
            `;
            reportIssueStudentList.appendChild(studentDiv);
        });
    }

    function validateReportIssueForm() {
        const category = issueCategory.value;
        const description = issueDescription.value.trim();
        const selectedStudents = reportIssueStudentList.querySelectorAll('input[type="checkbox"]:checked').length;
        
        if (category && description && selectedStudents > 0) {
            submitIssueReportBtn.disabled = false;
        } else {
            submitIssueReportBtn.disabled = true;
        }
    }

    // --- EVENT LISTENERS ---
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        loginPage.classList.add('hidden');
        dashboardPage.classList.remove('hidden');
        updateView();
    });
    
    searchInput.addEventListener('keyup', updateView);
    statusFilter.addEventListener('change', updateView);
    componentFilter.addEventListener('change', updateView);
    sortByNameBtn.addEventListener('click', () => {
        if (sortDirection === 'none') sortDirection = 'asc';
        else if (sortDirection === 'asc') sortDirection = 'desc';
        else sortDirection = 'none';
        sortIndicator.innerHTML = sortDirection === 'asc' ? '▲' : sortDirection === 'desc' ? '▼' : '◆';
        updateView();
    });
    
    tableBody.addEventListener('click', function(e) {
        const unsubmitButton = e.target.closest('.unsubmit-btn');
        if (unsubmitButton && !unsubmitButton.disabled) {
            openUnsubmitModal(unsubmitButton.dataset.studentId, unsubmitButton.dataset.studentName);
        }

        const unblockButton = e.target.closest('.unblock-btn');
        if (unblockButton) {
            openUnblockModal(unblockButton.dataset.studentId);
        }

        const watchCheckbox = e.target.closest('.watch-checkbox');
        if (watchCheckbox) {
            const studentId = watchCheckbox.dataset.studentId;
            const studentIndex = students.findIndex(s => s.id === studentId);
            if(studentIndex > -1) {
                students[studentIndex].watched = watchCheckbox.checked;
            }
            updateView();
        }

        const studentNameButton = e.target.closest('.student-name-btn');
        if (studentNameButton) {
            openStudentInfoModal(studentNameButton.dataset.studentId);
        }
    });

    tableBody.addEventListener('mouseover', function(e) {
        const disabledButtonWrapper = e.target.closest('.relative');
        if (disabledButtonWrapper) {
            const tooltip = disabledButtonWrapper.querySelector('.unsubmit-tooltip');
            if (tooltip) {
                tooltip.classList.remove('hidden');
            }
        }
    });

    tableBody.addEventListener('mouseout', function(e) {
        const disabledButtonWrapper = e.target.closest('.relative');
        if (disabledButtonWrapper) {
            const tooltip = disabledButtonWrapper.querySelector('.unsubmit-tooltip');
            if (tooltip) {
                tooltip.classList.add('hidden');
            }
        }
    });

    unsubmitRequestForm.addEventListener('submit', handleUnsubmitRequest);
    cancelUnsubmitBtn.addEventListener('click', closeUnsubmitModal);
    unsubmitModal.addEventListener('click', (e) => e.target === unsubmitModal && closeUnsubmitModal());

    unsubmitReason.addEventListener('change', function() {
        if (this.value === 'other') {
            otherReasonContainer.classList.remove('hidden');
        } else {
            otherReasonContainer.classList.add('hidden');
        }
        validateUnsubmitRequestForm();
    });
    
    otherReasonText.addEventListener('input', validateUnsubmitRequestForm);

    techSupportBtn.addEventListener('click', () => {
        techSupportModal.classList.remove('hidden');
    });
    dismissSupportModalBtn.addEventListener('click', () => {
        techSupportModal.classList.add('hidden');
    });
    techSupportModal.addEventListener('click', (e) => {
        if (e.target === techSupportModal) techSupportModal.classList.add('hidden');
    });
    
    function openStudentInfoModal(studentId) {
        const student = students.find(s => s.id === studentId);
        if (!student) return;

        studentInfoTitle.textContent = `Student Info: ${student.firstName} ${student.lastName}`;

        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            return new Date(timestamp).toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric', 
                hour: 'numeric', 
                minute: '2-digit', 
                timeZone: 'America/Vancouver',
                timeZoneName: 'short' 
            });
        };

        let actionsHtml = '';
        if (student.status === 'Submitted') {
            if (!isAfter4PM() && isUnsubmitAllowed(student.startTime)) {
                actionsHtml = `<button class="unsubmit-btn-modal btn-unsubmit-active" data-student-id="${student.id}" data-student-name="${student.firstName} ${student.lastName}">Unsubmit</button>`;
            }
        } else if (student.status === 'Blocked') {
            actionsHtml = `<button class="unblock-btn-modal btn-unsubmit-active" data-student-id="${student.id}">Unblock</button>`;
        }

        const content = `
            <table class="w-full text-sm">
                <tbody>
                    <tr class="border-b">
                        <td class="py-3 px-2 font-medium text-gray-600 w-1/3">Assessment Component</td>
                        <td class="py-3 px-2">${student.component}</td>
                    </tr>
                    <tr class="border-b">
                        <td class="py-3 px-2 font-medium text-gray-600">Assessment Status</td>
                        <td class="py-3 px-2 flex items-center justify-between">
                            <span>${student.status}</span>
                            ${actionsHtml}
                        </td>
                    </tr>
                    <tr class="border-b">
                        <td class="py-3 px-2 font-medium text-gray-600">Login Date & Time</td>
                        <td class="py-3 px-2">${formatDate(student.loginTime)}</td>
                    </tr>
                    <tr>
                        <td class="py-3 px-2 font-medium text-gray-600">Submission Date & Time</td>
                        <td class="py-3 px-2">${formatDate(student.submissionTime)}</td>
                    </tr>
                </tbody>
            </table>
        `;
        studentInfoContent.innerHTML = content;
        
        studentInfoModal.classList.remove('hidden');
    }
    
    studentInfoContent.addEventListener('click', function(e) {
        const unsubmitButton = e.target.closest('.unsubmit-btn-modal');
        if (unsubmitButton) {
            openUnsubmitModal(unsubmitButton.dataset.studentId, unsubmitButton.dataset.studentName);
        }
        const unblockButton = e.target.closest('.unblock-btn-modal');
        if (unblockButton) {
            openUnblockModal(unblockButton.dataset.studentId);
        }
    });

    function closeStudentInfoModal() {
        studentInfoModal.classList.add('hidden');
    }
    
    okStudentInfoBtn.addEventListener('click', closeStudentInfoModal);
    studentInfoModal.addEventListener('click', (e) => {
        if (e.target === studentInfoModal) closeStudentInfoModal();
    });

    // Report an Issue Logic
    reportIssueBtn.addEventListener('click', () => {
        reportIssueInfoModal.classList.remove('hidden');
    });

    cancelReportIssueInfoBtn.addEventListener('click', () => {
        reportIssueInfoModal.classList.add('hidden');
    });

    okReportIssueInfoBtn.addEventListener('click', () => {
        reportIssueInfoModal.classList.add('hidden');
        reportIssueFormModal.classList.remove('hidden');
        populateReportIssueStudentList();
        validateReportIssueForm();
    });

    cancelReportIssueFormBtn.addEventListener('click', () => {
        reportIssueFormModal.classList.add('hidden');
        reportIssueForm.reset();
    });

    reportIssueForm.addEventListener('input', validateReportIssueForm);

    reportIssueForm.addEventListener('submit', (e) => {
        e.preventDefault();
        // In a real application, you would send this data to a server.
        console.log('Issue Reported:', {
            category: issueCategory.value,
            description: issueDescription.value,
            students: Array.from(reportIssueStudentList.querySelectorAll('input:checked')).map(cb => cb.value)
        });
        reportIssueFormModal.classList.add('hidden');
        reportIssueForm.reset();
    });
    
    // Unblock Modal Logic
    confirmUnblockBtn.addEventListener('click', handleUnblock);
    cancelUnblockBtn.addEventListener('click', closeUnblockModal);
    unblockModal.addEventListener('click', (e) => e.target === unblockModal && closeUnblockModal());

</script>

</body>
</html>
