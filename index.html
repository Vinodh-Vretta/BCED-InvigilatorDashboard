<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCED Invigilation Dashboard - Updated</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
        }
        .header-bar {
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
        }
        .main-content {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        .btn-primary {
            background-color: #2c5cc5;
            color: white;
            border-radius: 4px;
            padding: 8px 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #234a9e;
        }
        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
            border-radius: 4px;
            padding: 8px 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
         .btn-secondary:hover {
            background-color: #d1d1d1;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }
        .status-dot.online { background-color: #4caf50; }
        .status-dot.offline { background-color: #d32f2f; }
        .status-dot.disconnected { background-color: #ffc107; } /* Yellow for disconnected */
        .table-cell-border {
            border-right: 1px solid #e0e0e0;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Login Page -->
    <div id="login-page">
        <div class="min-h-screen flex items-center justify-center bg-gray-100">
            <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">BCED Assessment Invigilation</h2>
                <form id="login-form">
                    <div class="space-y-6">
                        <div>
                            <label for="access-code" class="block text-sm font-medium text-gray-700">Invigilator Access Code</label>
                            <input type="text" id="access-code" name="access-code" value="PROCTOR-A1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <button type="submit" class="w-full btn-primary py-2">
                                Enter Session
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard Page (Initially Hidden) -->
    <div id="dashboard-page" class="hidden">
        <header class="header-bar px-6 py-3 flex justify-between items-center">
             <button id="file-incident-report-btn" class="text-sm font-medium text-red-600 hover:underline bg-red-100 px-3 py-2 rounded-md">
                <i class="fas fa-flag mr-2"></i>File Incident Report
            </button>
            <div class="flex items-center space-x-4">
                <button id="tech-support-btn" class="text-sm font-medium text-blue-600 hover:underline">Technical Support</button>
            </div>
        </header>

        <main class="p-6">
            <div class="main-content">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="text-2xl font-medium">Invigilation View</h1>
                            <p id="last-updated-timestamp" class="text-xs text-gray-500 mt-1">Last updated: ...</p>
                        </div>
                    </div>
                     <p class="text-sm text-gray-600 mt-4">
                        Number of students writing right now: <strong id="total-students-count" class="font-medium text-gray-800">0</strong>
                    </p>
                </div>
                
                <div class="p-6">
                     <div class="filter-controls flex justify-between items-center mb-4">
                        <input type="text" id="search-input" placeholder="Search by Student Name or PEN" class="px-3 py-2 border border-gray-300 rounded-md w-full max-w-xs focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <div class="flex items-center space-x-4">
                             <div>
                                <label for="component-filter" class="text-sm font-medium text-gray-700 mr-2">Component:</label>
                                <select id="component-filter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                                    <option value="all">All Components</option>
                                    <option value="NME 10">NME 10</option>
                                    <option value="LTE10">LTE10</option>
                                    <option value="LTF12 (ORAL)">LTF12 (ORAL)</option>
                                    <option value="LTF12 (WRITTEN)">LTF12 (WRITTEN)</option>
                                    <option value="LTP10 (ORAL)">LTP10 (ORAL)</option>
                                    <option value="LTP10 (WRITTEN)">LTP10 (WRITTEN)</option>
                                    <option value="LTP12 (ORAL)">LTP12 (ORAL)</option>
                                    <option value="LTP12 (WRITTEN)">LTP12 (WRITTEN)</option>
                                </select>
                            </div>
                            <div>
                                <label for="status-filter" class="text-sm font-medium text-gray-700 mr-2">Status:</label>
                                <select id="status-filter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                                    <option value="all">All Statuses</option>
                                    <option value="Not Started">Not Started</option>
                                    <option value="Ready to Start">Ready to Start</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Submitted">Submitted</option>
                                    <option value="Unsubmit Requested">Unsubmit Requested</option>
                                    <option value="Awaiting Ministerial Decision">Awaiting Ministerial Decision</option>
                                    <option value="Disconnected">Disconnected</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="table-container overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="border-b-2 border-gray-300">
                            <tr>
                                <th class="py-2 px-3 w-24 font-medium text-gray-700">Watch</th>
                                <th scope="col" class="py-2 px-3 font-medium text-gray-700 w-[15%]">PEN</th>
                                <th scope="col" class="py-2 px-3 font-medium text-blue-700 w-[30%]">
                                    <button id="sort-by-name-btn" class="w-full text-left">First Name / Last Name <span id="sort-indicator">◆</span></button>
                                </th>
                                <th scope="col" class="py-2 px-3 font-medium text-gray-700 w-[20%]">Component</th>
                                <th scope="col" class="py-2 px-3 font-medium text-gray-700 w-[30%]">Status</th>
                            </tr>
                        </thead>
                        <tbody id="student-table-body">
                            <!-- Student rows will be injected here by JavaScript -->
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="request-unsubmit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Request to Unsubmit Assessment</h3>
            <p class="text-sm text-gray-600 mb-4">For: <strong id="student-name-unsubmit-modal"></strong></p>
            <div class="space-y-4">
                <div>
                    <label for="unsubmit-reason" class="block text-sm font-medium text-gray-700">Reason for Request</label>
                    <select id="unsubmit-reason" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Accidental Submission">Accidental Submission</option>
                        <option value="Technical Issue">Technical Issue</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div id="other-reason-container" class="hidden">
                    <label for="other-reason-text" class="block text-sm font-medium text-gray-700">Please specify</label>
                    <textarea id="other-reason-text" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                 <div>
                    <label for="invigilator-email" class="block text-sm font-medium text-gray-700">Your Email for Notification</label>
                    <input type="email" id="invigilator-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancel-unsubmit" type="button" class="btn-secondary">Cancel</button>
                <button id="confirm-unsubmit" type-button" class="btn-primary">Submit Request</button>
            </div>
        </div>
    </div>
    
    <div id="tech-support-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl p-8 w-full max-w-lg mx-4">
            <h3 class="text-xl font-medium text-gray-900 mb-4">Information centre hours:</h3>
            <p class="text-lg text-gray-700 mb-6">
                <strong class="font-semibold">Monday to Friday:</strong><br>
                8:00 a.m. to 5:00 p.m. (EST)
            </p>
            <div class="border rounded-md overflow-hidden">
                <table class="w-full">
                    <tbody>
                        <tr class="border-b">
                            <td class="p-3 font-medium bg-gray-50 w-1/3">Email</td>
                            <td class="p-3 text-blue-600 font-medium">bced-support@vretta.com</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-medium bg-gray-50 w-1/3">Phone Number</td>
                            <td class="p-3 font-medium">1-888-887-3882</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-6 text-center">
                <button id="dismiss-support-modal" class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-2 px-6 rounded-md">
                    Dismiss Notification
                </button>
            </div>
        </div>
    </div>

    <div id="student-info-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
            <div class="p-4 border-b">
                <h2 id="student-info-modal-title" class="text-xl font-semibold text-gray-800">Student Info</h2>
            </div>
            <div id="student-info-modal-content" class="p-6">
                <!-- Content generated by JS -->
            </div>
            <div class="p-4 bg-gray-50 text-right border-t">
                 <button id="ok-student-info-modal" class="btn-primary">OK</button>
            </div>
        </div>
    </div>
    
    <div id="report-issue-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4">
            <div class="p-4 border-b">
                <h2 class="text-xl font-semibold text-gray-800">Disqualification Incident Report</h2>
            </div>
            <div class="p-6">
                 <div class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-md mb-6" role="alert">
                    <p class="font-bold">Time-sensitive Issues Requiring Technical Support</p>
                    <p class="text-sm">If the issue requires support to allow the student to start or continue the assessment, please call <strong class="font-semibold">1-888-887-3882</strong> for immediate assistance.</p>
                </div>
                <div class="space-y-4">
                     <div>
                        <label for="issue-category" class="block text-sm font-medium text-gray-700">Reported Issue Category:*</label>
                        <select id="issue-category" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Select a category</option>
                            <option value="Technical Issue / Device Issue">Technical Issue / Device Issue</option>
                            <option value="Problem with the Assessment">Problem with the Assessment</option>
                            <option value="Administration Anomaly or Academic Dishonesty">Administration Anomaly or Academic Dishonesty</option>
                        </select>
                    </div>
                    <div>
                        <label for="issue-assessment" class="block text-sm font-medium text-gray-700">Assessment(s):*</label>
                        <select id="issue-assessment" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                             <option value="">Select an assessment</option>
                        </select>
                    </div>
                    <div>
                        <label for="issue-description" class="block text-sm font-medium text-gray-700">Report Issue:*</label>
                        <textarea id="issue-description" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Students:*</label>
                        <div id="issue-student-list" class="mt-1 border border-gray-300 rounded-md h-40 overflow-y-auto p-2">
                           <!-- student list here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-50 flex justify-end space-x-4 border-t">
                 <button id="cancel-report-issue" class="btn-secondary">Cancel</button>
                 <button id="submit-report-issue" class="btn-primary" disabled>Report</button>
            </div>
        </div>
    </div>
    
    <div id="reentry-password-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-2">Student Re-entry Password</h3>
            <p class="text-sm text-gray-600 mb-4">For: <strong id="student-name-reentry-modal"></strong></p>
            <p class="text-sm text-gray-700">Provide the following password to the student to re-enter the assessment:</p>
            <div class="my-4 p-3 bg-gray-100 rounded-md border border-gray-300">
                <p id="reentry-password" class="text-2xl font-bold tracking-widest text-gray-800"></p>
            </div>
            <button id="close-reentry-modal" class="btn-primary w-full">Close</button>
        </div>
    </div>


<script>
    // --- MOCK DATA ---
    const initialStudents = [
        { id: '1', pen: '123456789', firstName: 'Emma', lastName: 'Thompson', component: 'NME 10', watched: true, connectionStatus: 'online', status: 'In Progress', time: 429566, lastSeen: null, submissionTime: null, assessments: [{ component: 'NME 10', status: 'In Progress', loginTime: '2025-07-28T08:00:00', submissionTime: null }] },
        { id: '2', pen: '987654321', firstName: 'Michael', lastName: 'Chen', component: 'NME 10', watched: false, connectionStatus: 'offline', status: 'Submitted', time: 8946, lastSeen: new Date().getTime() - 300000, submissionTime: new Date().getTime() - 300000, assessments: [{ component: 'NME 10', status: 'Submitted', loginTime: '2025-07-28T08:15:00', submissionTime: new Date(new Date().getTime() - 300000).toISOString() }] },
        { id: '3', pen: '456789123', firstName: 'Sarah', lastName: 'Johnson', component: 'LTE10', watched: false, connectionStatus: 'online', status: 'Submitted', time: 394, lastSeen: null, submissionTime: new Date().getTime() - (5 * 60 * 60 * 1000), assessments: [{ component: 'LTE10', status: 'Submitted', loginTime: '2025-07-28T09:00:00', submissionTime: new Date(new Date().getTime() - (5 * 60 * 60 * 1000)).toISOString() }] },
        { id: '4', pen: '789123456', firstName: 'David', lastName: 'Rodriguez', component: 'LTE10', watched: true, connectionStatus: 'disconnected', status: 'Disconnected', time: 0, lastSeen: new Date().getTime() - 60000, submissionTime: null, assessments: [{ component: 'LTE10', status: 'In Progress', loginTime: '2025-07-28T08:05:00', submissionTime: null }] },
        { id: '5', pen: '321654987', firstName: 'Jessica', lastName: 'Wu', component: 'NME 10', watched: false, connectionStatus: 'online', status: 'Submitted', time: 0, lastSeen: null, submissionTime: new Date().getTime() - (30 * 60 * 1000), assessments: [{ component: 'NME 10', status: 'Submitted', loginTime: '2025-07-28T09:30:00', submissionTime: new Date(new Date().getTime() - (30 * 60 * 1000)).toISOString() }] },
        { id: '6', pen: '234567890', firstName: 'Amanda', lastName: 'Singh', component: 'LTE10', watched: false, connectionStatus: 'online', status: 'Not Started', time: 0, lastSeen: null, submissionTime: null, assessments: [{ component: 'LTE10', status: 'Not Started', loginTime: null, submissionTime: null }] },
        { id: '7', pen: '345678901', firstName: 'James', lastName: 'Wilson', component: 'NME 10', watched: false, connectionStatus: 'offline', status: 'Ready to Start', time: 0, lastSeen: new Date().getTime() - 86400000, submissionTime: null, assessments: [{ component: 'NME 10', status: 'Ready to Start', loginTime: null, submissionTime: null }] },
        { id: '10', pen: '789012345', firstName: 'Sophia', lastName: 'Davis', component: 'NME 10', watched: false, connectionStatus: 'offline', status: 'Awaiting Ministerial Decision', time: 2134, lastSeen: new Date().getTime() - 1800000, submissionTime: new Date().getTime() - 1800000, assessments: [{ component: 'NME 10', status: 'Submitted', loginTime: '2025-07-28T10:00:00', submissionTime: new Date(new Date().getTime() - 1800000).toISOString() }] },
        { id: '26', pen: '345682901', firstName: 'Abigail', lastName: 'Hall', component: 'NME 10', watched: true, connectionStatus: 'disconnected', status: 'Disconnected', time: 445, lastSeen: new Date().getTime() - 90000, submissionTime: null, assessments: [{ component: 'NME 10', status: 'In Progress', loginTime: '2025-07-28T11:00:00', submissionTime: null }] },
        { id: '29', pen: '678915234', firstName: 'Jack', lastName: 'King', component: 'LTP10 (ORAL)', watched: false, connectionStatus: 'disconnected', status: 'Disconnected', time: 1234, lastSeen: new Date().getTime() - 180000, submissionTime: null, assessments: [{ component: 'LTP10 (ORAL)', status: 'In Progress', loginTime: '2025-07-28T08:45:00', submissionTime: null }] },
        { id: '36', pen: '112233445', firstName: 'Daniel', lastName: 'Lee', component: 'NME 10', watched: false, connectionStatus: 'disconnected', status: 'Disconnected', time: 800, lastSeen: new Date().getTime() - 500000, submissionTime: null, assessments: [{ component: 'NME 10', status: 'In Progress', loginTime: '2025-07-28T10:10:00', submissionTime: null }] },
        { id: '37', pen: '223344556', firstName: 'Sophie', lastName: 'Clark', component: 'LTE10', watched: true, connectionStatus: 'disconnected', status: 'Disconnected', time: 950, lastSeen: new Date().getTime() - 700000, submissionTime: null, assessments: [{ component: 'LTE10', status: 'In Progress', loginTime: '2025-07-28T10:20:00', submissionTime: null }] },
        { id: '38', pen: '334455667', firstName: 'Logan', lastName: 'Hall', component: 'LTF12 (ORAL)', watched: false, connectionStatus: 'online', status: 'In Progress', time: 1200, lastSeen: null, submissionTime: null, assessments: [{ component: 'LTF12 (ORAL)', status: 'In Progress', loginTime: '2025-07-28T11:30:00', submissionTime: null }] },
        { id: '39', pen: '445566778', firstName: 'Zoe', lastName: 'Hill', component: 'Written', watched: false, connectionStatus: 'offline', status: 'Awaiting Ministerial Decision', time: 0, lastSeen: new Date().getTime() - 600000, submissionTime: new Date().getTime() - 600000, assessments: [{ component: 'Written', status: 'Submitted', loginTime: '2025-07-28T09:45:00', submissionTime: new Date(new Date().getTime() - 600000).toISOString() }] }
    ];
    
    let students = [...initialStudents];
    let sortDirection = 'none';
    let unsubmitRequestData = {};

    // --- DOM ELEMENTS ---
    const loginPage = document.getElementById('login-page');
    const dashboardPage = document.getElementById('dashboard-page');
    const loginForm = document.getElementById('login-form');
    const lastUpdatedTimestamp = document.getElementById('last-updated-timestamp');
    const totalStudentsCount = document.getElementById('total-students-count');
    const tableBody = document.getElementById('student-table-body');
    const searchInput = document.getElementById('search-input');
    const statusFilter = document.getElementById('status-filter');
    const componentFilter = document.getElementById('component-filter');
    const sortByNameBtn = document.getElementById('sort-by-name-btn');
    const sortIndicator = document.getElementById('sort-indicator');
    
    const requestUnsubmitModal = document.getElementById('request-unsubmit-modal');
    const studentNameUnsubmitModal = document.getElementById('student-name-unsubmit-modal');
    const confirmUnsubmitBtn = document.getElementById('confirm-unsubmit');
    const cancelUnsubmitBtn = document.getElementById('cancel-unsubmit');
    const unsubmitReason = document.getElementById('unsubmit-reason');
    const otherReasonContainer = document.getElementById('other-reason-container');
    const otherReasonText = document.getElementById('other-reason-text');
    const invigilatorEmail = document.getElementById('invigilator-email');

    const techSupportBtn = document.getElementById('tech-support-btn');
    const techSupportModal = document.getElementById('tech-support-modal');
    const dismissSupportModalBtn = document.getElementById('dismiss-support-modal');
    
    const studentInfoModal = document.getElementById('student-info-modal');
    const studentInfoModalTitle = document.getElementById('student-info-modal-title');
    const studentInfoModalContent = document.getElementById('student-info-modal-content');
    const okStudentInfoBtn = document.getElementById('ok-student-info-modal');
    
    const fileIncidentReportBtn = document.getElementById('file-incident-report-btn');
    const reportIssueModal = document.getElementById('report-issue-modal');
    const cancelReportIssueBtn = document.getElementById('cancel-report-issue');
    const submitReportIssueBtn = document.getElementById('submit-report-issue');
    const issueCategory = document.getElementById('issue-category');
    const issueAssessment = document.getElementById('issue-assessment');
    const issueDescription = document.getElementById('issue-description');
    const issueStudentList = document.getElementById('issue-student-list');

    const reentryPasswordModal = document.getElementById('reentry-password-modal');
    const studentNameReentryModal = document.getElementById('student-name-reentry-modal');
    const reentryPassword = document.getElementById('reentry-password');
    const closeReentryModalBtn = document.getElementById('close-reentry-modal');
    
    // --- TIMEZONE ---
    const TIMEZONE = 'America/Vancouver';

    // --- FUNCTIONS ---
    function formatTime(date) {
        if (!date) return 'N/A';
        return new Date(date).toLocaleTimeString('en-US', { timeZone: TIMEZONE, hour: '2-digit', minute: '2-digit' });
    }

    function isAfter4PM() {
        const now = new Date(new Date().toLocaleString('en-US', { timeZone: TIMEZONE }));
        return now.getHours() >= 16;
    }

    function renderTable(studentData) {
        tableBody.innerHTML = '';
        totalStudentsCount.textContent = studentData.filter(s => s.connectionStatus === 'online').length;
        lastUpdatedTimestamp.textContent = `Last updated: ${new Date().toLocaleTimeString('en-US', { timeZone: TIMEZONE })}`;

        if (studentData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-500">No students found.</td></tr>`;
            return;
        }

        studentData.forEach(student => {
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200 hover:bg-gray-50 cursor-pointer';
            row.dataset.studentId = student.id;
            
            let connectionStatusClass;
            let connectionStatusText;

            switch(student.connectionStatus) {
                case 'online':
                    connectionStatusClass = 'online';
                    connectionStatusText = 'Writing';
                    break;
                case 'offline':
                    connectionStatusClass = 'offline';
                    connectionStatusText = 'Offline';
                    break;
                case 'disconnected':
                    connectionStatusClass = 'disconnected';
                    connectionStatusText = 'Disconnected';
                    break;
            }
            
            let statusContent = '';
            if (student.status === 'Submitted') {
                const isPast4PM = isAfter4PM();
                const canUnsubmit = !isPast4PM;
                
                statusContent = `
                    <div class="flex items-center space-x-2">
                         <p class="font-medium text-gray-700">${student.status}</p>
                        <div class="relative">
                            <button 
                                class="unsubmit-btn text-sm font-medium ${canUnsubmit ? 'text-gray-600 bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-md' : 'text-gray-400 cursor-not-allowed bg-gray-100 px-3 py-1 rounded-md'}"
                                data-student-id="${student.id}"
                                data-student-name="${student.firstName} ${student.lastName}"
                                ${!canUnsubmit ? 'disabled' : ''}
                            >
                                Unsubmit
                            </button>
                            <div class="unsubmit-tooltip hidden absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-md whitespace-nowrap z-50">
                                ${isPast4PM 
                                    ? `Unsubmit is unavailable after 4 PM. Contact support:<br>Phone: 1-888-887-3882`
                                    : `1-hour window expired. Request will be sent for approval.`
                                }
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                            </div>
                        </div>
                    </div>`;

            } else if (student.status === 'In Progress' || student.status === 'Ready to Start' || student.status === 'Not Started' || student.status === 'Awaiting Ministerial Decision' || student.status === 'Unsubmit Requested' || student.status === 'Disconnected') {
                statusContent = `<p class="font-medium text-gray-700">${student.status}</p>`;
            } 
            
            let statusBgClass = '';
            if (student.status === 'Ready to Start') statusBgClass = 'bg-[#fff3e0]';
            else if (student.status === 'Not Started') statusBgClass = 'bg-gray-100';

            let lastSeenHtml = '';
            if (student.connectionStatus !== 'online' && student.lastSeen) {
                lastSeenHtml = `<span class="text-xs text-gray-500 ml-2">(Last seen: ${formatTime(student.lastSeen)})</span>`;
            }

            row.innerHTML = `
                <td class="py-3 px-3 table-cell-border text-center">
                    <input type="checkbox" class="watch-checkbox" data-student-id="${student.id}" ${student.watched ? 'checked' : ''}>
                </td>
                <td class="py-3 px-3 table-cell-border">${student.pen}</td>
                <td class="py-3 px-3 table-cell-border">
                    <div class="font-medium text-blue-700">${student.firstName} ${student.lastName}</div>
                    <div class="text-xs text-gray-700 mt-1">
                        <span class="status-dot ${connectionStatusClass}"></span>
                        <span>${connectionStatusText}</span>
                        ${lastSeenHtml}
                    </div>
                </td>
                <td class="py-3 px-3 table-cell-border">
                    <span class="text-sm font-medium text-gray-700">${student.component}</span>
                </td>
                <td class="py-3 px-3 ${statusBgClass}">${statusContent}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    function updateView() {
        let displayedStudents = [...students];

        const selectedStatus = statusFilter.value;
        const selectedComponent = componentFilter.value;
        if (selectedStatus !== 'all') {
            displayedStudents = displayedStudents.filter(s => s.status === selectedStatus);
        }
        if (selectedComponent !== 'all') {
            displayedStudents = displayedStudents.filter(s => s.component === selectedComponent);
        }

        const searchTerm = searchInput.value.toLowerCase();
        if (searchTerm) {
            displayedStudents = displayedStudents.filter(student => 
                `${student.firstName} ${student.lastName}`.toLowerCase().includes(searchTerm) || 
                student.pen.toLowerCase().includes(searchTerm)
            );
        }

        const statusOrder = ["In Progress", "Ready to Start", "Disconnected", "Not Started", "Submitted", "Unsubmit Requested", "Awaiting Ministerial Decision"];
        
        displayedStudents.sort((a, b) => {
            if (a.watched && !b.watched) return -1;
            if (!a.watched && b.watched) return 1;

            const aOnline = a.connectionStatus === 'online';
            const bOnline = b.connectionStatus === 'online';
            if (aOnline && !bOnline) return -1;
            if (!aOnline && bOnline) return 1;

            const statusIndexA = statusOrder.indexOf(a.status);
            const statusIndexB = statusOrder.indexOf(b.status);
            if (statusIndexA !== statusIndexB) return statusIndexA - statusIndexB;

            const nameA = `${a.lastName} ${a.firstName}`.toLowerCase();
            const nameB = `${b.lastName} ${b.firstName}`.toLowerCase();
            if (nameA < nameB) return sortDirection === 'asc' ? -1 : 1;
            if (nameA > nameB) return sortDirection === 'asc' ? 1 : -1;
            
            return a.component.localeCompare(b.component);
        });
        
        renderTable(displayedStudents);
    }

    // --- MODAL & ACTION FUNCTIONS ---
    
    function openRequestUnsubmitModal(studentId, studentName) {
        const student = students.find(s => s.id === studentId);
        if (!student) return;

        studentNameUnsubmitModal.textContent = studentName;
        confirmUnsubmitBtn.dataset.studentId = studentId;

        const oneHourInMs = 60 * 60 * 1000;
        const timeSinceSubmission = new Date().getTime() - student.submissionTime;
        const accidentalSubmissionOption = unsubmitReason.querySelector('option[value="Accidental Submission"]');
        
        if (timeSinceSubmission > oneHourInMs) {
            accidentalSubmissionOption.disabled = true;
            if(unsubmitReason.value === "Accidental Submission") {
                unsubmitReason.value = "Technical Issue";
            }
        } else {
            accidentalSubmissionOption.disabled = false;
        }

        // Restore data if it exists
        if (unsubmitRequestData[studentId]) {
            invigilatorEmail.value = unsubmitRequestData[studentId].email || '';
            unsubmitReason.value = unsubmitRequestData[studentId].reason || 'Accidental Submission';
            otherReasonText.value = unsubmitRequestData[studentId].otherText || '';
        } else {
             invigilatorEmail.value = '';
             unsubmitReason.value = accidentalSubmissionOption.disabled ? "Technical Issue" : "Accidental Submission";
             otherReasonText.value = '';
        }
        
        unsubmitReason.dispatchEvent(new Event('change')); // Trigger change to show/hide other field
        requestUnsubmitModal.classList.remove('hidden');
    }

    function closeRequestUnsubmitModal() {
        const studentId = confirmUnsubmitBtn.dataset.studentId;
         if (studentId) {
            unsubmitRequestData[studentId] = {
                email: invigilatorEmail.value,
                reason: unsubmitReason.value,
                otherText: otherReasonText.value,
            };
        }
        requestUnsubmitModal.classList.add('hidden');
    }

    function handleUnsubmitRequest() {
        const studentId = confirmUnsubmitBtn.dataset.studentId;
        const studentIndex = students.findIndex(s => s.id === studentId);
        if (studentIndex === -1) return;

        const student = students[studentIndex];
        const oneHourInMs = 60 * 60 * 1000;
        const timeSinceSubmission = new Date().getTime() - student.submissionTime;

        if (timeSinceSubmission <= oneHourInMs && unsubmitReason.value === "Accidental Submission") {
            // Auto-approve
            students[studentIndex].status = 'In Progress';
        } else {
            // Send for ministerial approval
            students[studentIndex].status = 'Awaiting Ministerial Decision';
        }

        delete unsubmitRequestData[studentId]; // Clear stored data
        updateView();
        requestUnsubmitModal.classList.add('hidden'); // Use direct close without saving
    }
    
     function openStudentInfoModal(studentId) {
        const student = students.find(s => s.id === studentId);
        if (!student) return;

        studentInfoModalTitle.textContent = `Student Info: ${student.firstName} ${student.lastName}`;
        
        let assessmentsHtml = '<div class="space-y-4">';
        student.assessments.forEach(asm => {
            let actionButtonHtml = '';
            if (asm.status === 'Submitted') {
                 actionButtonHtml = `<button class="unsubmit-btn text-sm font-medium text-gray-600 bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-md ml-4" data-student-id="${student.id}" data-student-name="${student.firstName} ${student.lastName}">Unsubmit</button>`;
            }

            assessmentsHtml += `
                <div class="border rounded-md p-3">
                    <div class="flex justify-between items-center">
                        <h4 class="font-semibold">${asm.component}</h4>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                        <p><strong>Status:</strong> ${asm.status} ${actionButtonHtml}</p>
                        <p><strong>Login Date & Time:</strong> ${asm.loginTime ? new Date(asm.loginTime).toLocaleString('en-US', { timeZone: TIMEZONE }) : 'N/A'}</p>
                        <p><strong>Submission Date & Time:</strong> ${asm.submissionTime ? new Date(asm.submissionTime).toLocaleString('en-US', { timeZone: TIMEZONE }) : 'N/A'}</p>
                    </div>
                </div>
            `;
        });
        assessmentsHtml += '</div>';

        studentInfoModalContent.innerHTML = assessmentsHtml;
        studentInfoModal.classList.remove('hidden');
    }
    
    function closeStudentInfoModal() {
        studentInfoModal.classList.add('hidden');
    }

    function openReportIssueModal() {
        // Populate student list
        issueStudentList.innerHTML = '';
        students.forEach(s => {
            issueStudentList.innerHTML += `
                <div class="flex items-center">
                    <input type="checkbox" id="student-${s.id}" value="${s.id}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                    <label for="student-${s.id}" class="ml-3 block text-sm text-gray-700">${s.firstName} ${s.lastName}</label>
                </div>
            `;
        });

        // Populate assessment list
        const uniqueAssessments = [...new Set(students.map(s => s.component))];
        issueAssessment.innerHTML = '<option value="">Select an assessment</option>';
        uniqueAssessments.forEach(a => {
            issueAssessment.innerHTML += `<option value="${a}">${a}</option>`;
        });

        reportIssueModal.classList.remove('hidden');
    }

    function closeReportIssueModal() {
        reportIssueModal.classList.add('hidden');
    }

    function validateReportForm() {
        const category = issueCategory.value;
        const assessment = issueAssessment.value;
        const description = issueDescription.value.trim();
        const selectedStudents = issueStudentList.querySelectorAll('input:checked').length;
        
        submitReportIssueBtn.disabled = !(category && assessment && description && selectedStudents > 0);
    }

    function openReentryPasswordModal(studentId) {
        const student = students.find(s => s.id === studentId);
        if(!student) return;

        const password = Math.random().toString(36).substring(2, 8).toUpperCase();
        studentNameReentryModal.textContent = `${student.firstName} ${student.lastName}`;
        reentryPassword.textContent = password;
        reentryPasswordModal.dataset.studentId = studentId;
        reentryPasswordModal.classList.remove('hidden');
    }

    function closeReentryPasswordModal() {
        const studentId = reentryPasswordModal.dataset.studentId;
        const studentIndex = students.findIndex(s => s.id === studentId);
        if (studentIndex > -1) {
            students[studentIndex].status = 'In Progress';
            students[studentIndex].connectionStatus = 'online';
        }
        reentryPasswordModal.classList.add('hidden');
        updateView();
    }


    // --- EVENT LISTENERS ---
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        loginPage.classList.add('hidden');
        dashboardPage.classList.remove('hidden');
        updateView();
    });
    
    searchInput.addEventListener('input', updateView);
    statusFilter.addEventListener('change', updateView);
    componentFilter.addEventListener('change', updateView);
    sortByNameBtn.addEventListener('click', () => {
        if (sortDirection === 'none') sortDirection = 'asc';
        else if (sortDirection === 'asc') sortDirection = 'desc';
        else sortDirection = 'none';
        sortIndicator.innerHTML = sortDirection === 'asc' ? '▲' : sortDirection === 'desc' ? '▼' : '◆';
        updateView();
    });
    
    tableBody.addEventListener('click', function(e) {
        const unsubmitButton = e.target.closest('.unsubmit-btn');
        const watchCheckbox = e.target.closest('.watch-checkbox');
        const studentRow = e.target.closest('tr');

        if (unsubmitButton && !unsubmitButton.disabled) {
            e.stopPropagation();
            openRequestUnsubmitModal(unsubmitButton.dataset.studentId, unsubmitButton.dataset.studentName);
        } else if (watchCheckbox) {
             e.stopPropagation();
            const studentId = watchCheckbox.dataset.studentId;
            const studentIndex = students.findIndex(s => s.id === studentId);
            if(studentIndex > -1) {
                students[studentIndex].watched = watchCheckbox.checked;
            }
            updateView();
        } else if (studentRow) {
            const studentId = studentRow.dataset.studentId;
            const student = students.find(s => s.id === studentId);
            if (student && student.status === 'Disconnected') {
                openReentryPasswordModal(studentId);
            } else {
                openStudentInfoModal(studentId);
            }
        }
    });

    // Unsubmit button tooltip
    tableBody.addEventListener('mouseover', e => {
        const button = e.target.closest('.unsubmit-btn:disabled');
        if (button) {
            const tooltip = button.parentElement.querySelector('.unsubmit-tooltip');
            if (tooltip) tooltip.classList.remove('hidden');
        }
    });
    tableBody.addEventListener('mouseout', e => {
        const button = e.target.closest('.unsubmit-btn:disabled');
        if (button) {
            const tooltip = button.parentElement.querySelector('.unsubmit-tooltip');
            if (tooltip) tooltip.classList.add('hidden');
        }
    });

    // Modals
    confirmUnsubmitBtn.addEventListener('click', handleUnsubmitRequest);
    cancelUnsubmitBtn.addEventListener('click', closeRequestUnsubmitModal);
    unsubmitReason.addEventListener('change', () => {
        otherReasonContainer.classList.toggle('hidden', unsubmitReason.value !== 'Other');
        validateUnsubmitRequest();
    });
    otherReasonText.addEventListener('input', validateUnsubmitRequest);
    invigilatorEmail.addEventListener('input', validateUnsubmitRequest);

    function validateUnsubmitRequest() {
        const isOther = unsubmitReason.value === 'Other';
        const otherTextFilled = otherReasonText.value.trim() !== '';
        const emailFilled = invigilatorEmail.value.trim() !== '';

        confirmUnsubmitBtn.disabled = !emailFilled || (isOther && !otherTextFilled);
    }
    
    techSupportBtn.addEventListener('click', () => techSupportModal.classList.remove('hidden'));
    dismissSupportModalBtn.addEventListener('click', () => techSupportModal.classList.add('hidden'));
    
    okStudentInfoBtn.addEventListener('click', closeStudentInfoModal);
    studentInfoModal.addEventListener('click', (e) => {
        if (!e.target.closest('.modal-content')) closeStudentInfoModal();
    });

    fileIncidentReportBtn.addEventListener('click', openReportIssueModal);
    cancelReportIssueBtn.addEventListener('click', closeReportIssueModal);
    [issueCategory, issueAssessment, issueDescription].forEach(el => el.addEventListener('input', validateReportForm));
    issueStudentList.addEventListener('change', validateReportForm);

    closeReentryModalBtn.addEventListener('click', closeReentryPasswordModal);

    // Initial Load
    updateView();
    
</script>

</body>
</html>

