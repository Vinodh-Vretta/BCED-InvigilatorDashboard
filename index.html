<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCED Invigilation Dashboard - Reskinned</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5; /* Matching the light grey background */
        }
        .header-bar {
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
        }
        .main-content {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        .btn-primary {
            background-color: #2c5cc5;
            color: white;
            border-radius: 4px;
            padding: 8px 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #234a9e;
        }
        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
            border-radius: 4px;
            padding: 8px 16px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
         .btn-secondary:hover {
            background-color: #d1d1d1;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }
        .status-dot.online { background-color: #4caf50; }
        .status-dot.offline { background-color: #d32f2f; }
        .status-dot.disconnected { background-color: #ffc107; } /* Yellow for disconnected */
        .scan-issue { color: #d32f2f; font-weight: 500; }
        .table-cell-border {
            border-right: 1px solid #e0e0e0;
        }
        .access-code-box {
            background-color: #fce4ec; /* Light pink background */
            border: 1px solid #f8bbd0;
            border-radius: 6px;
            padding: 8px 16px;
            text-align: center;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Login Page -->
    <div id="login-page">
        <div class="min-h-screen flex items-center justify-center bg-gray-100">
            <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">BCED Assessment Invigilation</h2>
                <form id="login-form">
                    <div class="space-y-6">
                        <div>
                            <label for="session-code" class="block text-sm font-medium text-gray-700">Assessment Session Code/Password</label>
                            <input type="password" id="session-code" name="session-code" value="12345" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <button type="submit" class="w-full btn-primary py-2">
                                Enter Session
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard Page (Initially Hidden) -->
    <div id="dashboard-page" class="hidden">
        <header class="header-bar px-6 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4 text-sm">
                <a href="#" class="text-gray-600 hover:text-blue-600">Classic Viewings</a>
                <span>/</span>
                <a href="#" class="text-gray-600 hover:text-blue-600">Testing Class</a>
                 <span>/</span>
                <span class="text-gray-800 font-medium">Sample Test</span>
            </div>
            <div class="flex items-center space-x-4">
                <button id="tech-support-btn" class="text-sm font-medium text-blue-600 hover:underline">Technical Support</button>
                <button id="message-centre-btn" class="text-sm font-medium text-blue-600 hover:underline">Message Centre</button>
            </div>
        </header>

        <main class="p-6">
            <div class="main-content">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="text-2xl font-medium">Invigilation View</h1>
                            <div class="flex items-center space-x-4 text-sm text-gray-500 mt-1">
                                <span id="school-date-info">July 8, 2025</span>
                                <span>•</span>
                                <span id="last-updated">Last updated: <span id="last-updated-time"></span></span>
                            </div>
                        </div>
                    </div>
                     <p class="text-sm text-gray-600 mt-4">
                        Number of students with access to the assessment session: <strong id="total-students-count" class="font-medium text-gray-800">0</strong>
                    </p>
                </div>
                
                <div class="p-6">
                     <div class="flex justify-between items-center mb-4 space-x-4">
                        <input type="text" id="search-input" placeholder="Search by Student Name or PEN" class="px-3 py-2 border border-gray-300 rounded-md w-full max-w-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <div class="flex space-x-4">
                            <div>
                                <label for="status-filter" class="text-sm font-medium text-gray-700 mr-2">Filter by Status:</label>
                                <select id="status-filter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                                    <option value="all">All Statuses</option>
                                    <option value="Writing">Writing</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Submitted">Submitted</option>
                                    <option value="Not Started">Not Started</option>
                                    <option value="Ready to Start">Ready to Start</option>
                                </select>
                            </div>
                            <div>
                                <label for="component-filter" class="text-sm font-medium text-gray-700 mr-2">Filter by Component:</label>
                                <select id="component-filter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                                    <option value="all">All Components</option>
                                    <option value="Numeracy">Numeracy</option>
                                    <option value="Literacy">Literacy</option>
                                </select>
                            </div>
                            </select>
                        </div>
                    </div>
                    <table class="w-full text-sm text-left table-fixed">
                        <thead class="border-b-2 border-gray-300">
                            <tr>
                                <th scope="col" class="py-2 px-3 font-medium text-gray-700 w-[10%]">Watch</th>
                                <th scope="col" class="py-2 px-3 font-medium text-gray-700 w-[15%]">PEN</th>
                                <th scope="col" class="py-2 px-3 font-medium text-blue-700 w-[35%]">
                                    <button id="sort-by-name-btn" class="w-full text-left">First Name / Last Name <span id="sort-indicator">◆</span></button>
                                </th>
                                <th scope="col" class="py-2 px-3 font-medium text-gray-700 w-[40%]">Status</th>
                            </tr>
                        </thead>
                        <tbody id="student-table-body">
                            <!-- Student rows will be injected here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals remain the same -->
    <div id="unsubmit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Unsubmit Assessment</h3>
            <p class="text-sm text-gray-500 mb-6">
                Are you sure you want to unsubmit the assessment for <strong id="student-name-modal"></strong>? This will allow them to re-enter and complete their test. This action cannot be undone.
            </p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-unsubmit" type="button" class="btn-secondary">Cancel</button>
                <button id="confirm-unsubmit" type="button" class="btn-primary">Confirm Unsubmit</button>
            </div>
        </div>
    </div>
    <div id="tech-support-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg mx-4">
            <h3 class="text-xl font-medium text-gray-900 mb-4">Information centre hours:</h3>
            <p class="text-lg text-gray-700 mb-6">
                <strong class="font-semibold">Monday to Friday:</strong><br>
                8:00 a.m. to 5:00 p.m. (EST)
            </p>
            <div class="border rounded-md overflow-hidden">
                <table class="w-full">
                    <tbody>
                        <tr class="border-b">
                            <td class="p-3 font-medium bg-gray-50 w-1/3">Email</td>
                            <td class="p-3 text-blue-600 font-medium">bced-support@vretta.com</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-medium bg-gray-50 w-1/3">Phone Number</td>
                            <td class="p-3 font-medium">1 888-327-7377</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-6 text-center">
                <button id="dismiss-support-modal" class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-2 px-6 rounded-md">
                    Dismiss Notification
                </button>
            </div>
        </div>
    </div>
    <div id="message-centre-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl mx-4 h-3/4 flex flex-col">
            <div class="p-4 border-b">
                <h2 class="text-xl font-semibold text-gray-800">Message Centre</h2>
            </div>
            <div class="p-4 border-b flex space-x-1">
                <button class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md">All Messages</button>
                <button class="px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-md">Unread Messages</button>
                <button class="px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-md">Archived Messages</button>
            </div>
            <div class="flex-grow p-4 overflow-y-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b">
                            <th class="py-2 px-3 text-left font-medium text-gray-600">Subject</th>
                            <th class="py-2 px-3 text-left font-medium text-gray-600">Sent On</th>
                            <th class="py-2 px-3 text-left font-medium text-gray-600">Archive</th>
                        </tr>
                    </thead>
                </table>
                <div class="flex items-center justify-center h-full text-gray-500">
                    No Rows To Show
                </div>
            </div>
            <div class="p-4 border-t">
                <div class="w-full h-2 bg-gray-200 rounded-full">
                    <div class="w-1/4 h-full bg-gray-400 rounded-full"></div>
                </div>
            </div>
             <div class="text-center pb-4">
                 <button id="dismiss-message-modal" class="text-sm font-medium text-blue-600 hover:underline">Close</button>
            </div>
        </div>
    </div>
    <div id="student-info-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
            <div class="p-4 border-b">
                <h2 class="text-xl font-semibold text-gray-800">View/Edit Student Info</h2>
            </div>
            <div class="p-6">
                <table class="w-full text-sm">
                    <tbody>
                        <tr class="border-b">
                            <td class="py-3 px-2 font-medium text-gray-600 w-1/3">PEN</td>
                            <td id="info-pen" class="py-3 px-2"></td>
                        </tr>
                        <tr class="border-b">
                            <td class="py-3 px-2 font-medium text-gray-600">First Name</td>
                            <td id="info-first-name" class="py-3 px-2"></td>
                        </tr>
                         <tr class="border-b">
                            <td class="py-3 px-2 font-medium text-gray-600">Last Name</td>
                            <td id="info-last-name" class="py-3 px-2"></td>
                        </tr>
                        <tr class="border-b">
                            <td class="py-3 px-2 font-medium text-gray-600">Gender</td>
                            <td id="info-gender" class="py-3 px-2"></td>
                        </tr>
                        <tr class="border-b">
                            <td class="py-3 px-2 font-medium text-gray-600">Accommodations</td>
                            <td id="info-accommodations" class="py-3 px-2"></td>
                        </tr>
                        <tr class="border-b">
                            <td class="py-3 px-2 font-medium text-gray-600">Notes from the Teacher</td>
                            <td id="info-notes" class="py-3 px-2"></td>
                        </tr>
                         <tr class="border-b">
                            <td class="py-3 px-2 font-medium text-gray-600">Assistive Technology</td>
                            <td id="info-assistive-tech" class="py-3 px-2"></td>
                        </tr>
                        <tr>
                            <td class="py-3 px-2 font-medium text-gray-600">Non-participation Status</td>
                            <td id="info-non-participation" class="py-3 px-2"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="p-4 bg-gray-50 text-right border-t">
                 <button id="ok-student-info-modal" class="btn-primary">OK</button>
            </div>
        </div>
    </div>

<script>
    // --- MOCK DATA ---
    const initialStudents = [
        { id: '1', pen: '123456789', firstName: 'Emma', lastName: 'Thompson', component: 'Numeracy', connectionStatus: 'writing', status: 'In Progress', stage: 1, question: 3, startTime: Date.now() - (2 * 60 * 60 * 1000), watched: false, lastSeen: null },
        { id: '2', pen: '987654321', firstName: 'Michael', lastName: 'Chen', component: 'Numeracy', connectionStatus: 'offline', status: 'Submitted', stage: null, question: null, startTime: Date.now() - (4 * 60 * 60 * 1000), watched: false, lastSeen: Date.now() - (10 * 60 * 1000) },
        { id: '3', pen: '456789123', firstName: 'Sarah', lastName: 'Johnson', component: 'Literacy', connectionStatus: 'writing', status: 'Submitted', stage: null, question: null, startTime: Date.now() - (1 * 60 * 60 * 1000), watched: false, lastSeen: null },
        { id: '4', pen: '789123456', firstName: 'David', lastName: 'Rodriguez', component: 'Numeracy', connectionStatus: 'disconnected', status: 'In Progress', stage: 2, question: 5, startTime: Date.now() - (5 * 60 * 60 * 1000), watched: false, lastSeen: Date.now() - (5 * 60 * 1000) },
        { id: '5', pen: '321654987', firstName: 'Jessica', lastName: 'Wu', component: 'Literacy', connectionStatus: 'writing', status: 'Submitted', stage: null, question: null, startTime: Date.now() - (30 * 60 * 1000), watched: false, lastSeen: null },
        { id: '6', pen: '234567890', firstName: 'Amanda', lastName: 'Singh', component: 'Numeracy', connectionStatus: 'writing', status: 'Not Started', stage: null, question: null, startTime: null, watched: false, lastSeen: null },
        { id: '7', pen: '345678901', firstName: 'James', lastName: 'Wilson', component: 'Literacy', connectionStatus: 'offline', status: 'Ready to Start', stage: null, question: null, startTime: null, watched: false, lastSeen: Date.now() - (15 * 60 * 1000) },
    ];
    
    let students = [...initialStudents];
    let sortDirection = 'none';

    // --- DOM ELEMENTS ---
    const loginPage = document.getElementById('login-page');
    const dashboardPage = document.getElementById('dashboard-page');
    const loginForm = document.getElementById('login-form');
    const schoolDateInfo = document.getElementById('school-date-info');
    const totalStudentsCount = document.getElementById('total-students-count');
    const tableBody = document.getElementById('student-table-body');
    const searchInput = document.getElementById('search-input');
    const statusFilter = document.getElementById('status-filter');
    const componentFilter = document.getElementById('component-filter');
    const sortByNameBtn = document.getElementById('sort-by-name-btn');
    const sortIndicator = document.getElementById('sort-indicator');
    const lastUpdatedTime = document.getElementById('last-updated-time');
    const unsubmitModal = document.getElementById('unsubmit-modal');
    const studentNameUnsubmitModal = document.getElementById('student-name-modal');
    const confirmUnsubmitBtn = document.getElementById('confirm-unsubmit');
    const cancelUnsubmitBtn = document.getElementById('cancel-unsubmit');
    const techSupportBtn = document.getElementById('tech-support-btn');
    const techSupportModal = document.getElementById('tech-support-modal');
    const dismissSupportModalBtn = document.getElementById('dismiss-support-modal');
    const messageCentreBtn = document.getElementById('message-centre-btn');
    const messageCentreModal = document.getElementById('message-centre-modal');
    const dismissMessageModalBtn = document.getElementById('dismiss-message-modal');
    const studentInfoModal = document.getElementById('student-info-modal');
    const okStudentInfoBtn = document.getElementById('ok-student-info-modal');

    // --- FUNCTIONS ---
    function updateLastUpdatedTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        });
        lastUpdatedTime.textContent = timeString;
    }

    function formatLastSeen(lastSeenTime) {
        if (!lastSeenTime) return '';
        const minutesAgo = Math.floor((Date.now() - lastSeenTime) / (1000 * 60));
        return `Last seen ${minutesAgo} min ago`;
    }

    function isUnsubmitAllowed(student) {
        if (!student.startTime || student.status !== 'Submitted') return false;
        const threeHoursInMs = 3 * 60 * 60 * 1000; // 3 hours in milliseconds
        const timeSinceStart = Date.now() - student.startTime;
        return timeSinceStart < threeHoursInMs;
    }

    function renderTable(studentData) {
        tableBody.innerHTML = '';
        totalStudentsCount.textContent = studentData.length;

        if (studentData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-8 text-gray-500">No students found.</td></tr>`;
            return;
        }

        studentData.forEach(student => {
            const row = document.createElement('tr');
            row.className = `border-b border-gray-200 hover:bg-gray-50 ${student.watched ? 'bg-blue-50' : ''}`;
            
            let connectionStatusClass = 'offline';
            let connectionStatusText = 'Offline';
            if (student.connectionStatus === 'writing') {
                connectionStatusClass = 'online';
                connectionStatusText = 'Writing';
            }
            if (student.connectionStatus === 'disconnected') connectionStatusClass = 'disconnected';
            if (student.connectionStatus === 'disconnected') connectionStatusText = 'Disconnected';
            
            let connectionDisplay = connectionStatusText;
            if ((student.connectionStatus === 'offline' || student.connectionStatus === 'disconnected') && student.lastSeen) {
                connectionDisplay += ` - ${formatLastSeen(student.lastSeen)}`;
            }
            
            let statusContent = '';
            if (student.status === 'Submitted') {
                const canUnsubmit = isUnsubmitAllowed(student);
                const buttonClass = canUnsubmit 
                    ? "unsubmit-btn text-blue-700 hover:underline text-sm font-medium cursor-pointer" 
                    : "text-gray-400 text-sm font-medium cursor-not-allowed";
                const buttonText = canUnsubmit ? "Unsubmit" : "Unsubmit (3hr limit exceeded)";
                
                if (canUnsubmit) {
                    statusContent = `<div>
                                        <button class="${buttonClass}" data-student-id="${student.id}" data-student-name="${student.firstName} ${student.lastName}">${buttonText}</button>
                                     </div>`;
                } else {
                    statusContent = `<div class="tooltip">
                                        <button class="${buttonClass}" disabled>${buttonText}</button>
                                        <span class="tooltiptext">The 3-hour unsubmission window has expired. Please contact technical support at bced-support@vretta.com or 1-888-327-7377 for assistance with unsubmissions beyond this timeframe.</span>
                                     </div>`;
                }
            } else if (student.status === 'In Progress') {
                 statusContent = `<div>
                                    <p class="font-medium">Stage ${student.stage}, Question ${student.question}</p>
                                 </div>`;
            } else {
                statusContent = `<p class="font-medium text-gray-700">${student.status}</p>`;
            }

            let statusBgClass = '';
            if (student.status === 'Ready to Start') statusBgClass = 'bg-[#fff3e0]';
            else if (student.status === 'Not Started') statusBgClass = 'bg-gray-100';

            row.innerHTML = `
                <td class="py-3 px-3 table-cell-border">
                    <input type="checkbox" class="watch-checkbox" data-student-id="${student.id}" ${student.watched ? 'checked' : ''}>
                </td>
                <td class="py-3 px-3 table-cell-border">
                    <span class="text-gray-800 text-sm font-medium">${student.pen}</span>
                </td>
                <td class="py-3 px-3 table-cell-border">
                    <button class="student-name-btn text-blue-700 font-medium hover:underline" data-student-id="${student.id}">${student.firstName} ${student.lastName}</button>
                    <div class="text-xs text-gray-700 mt-1">
                        <span class="status-dot ${connectionStatusClass}"></span>
                        <span>${connectionDisplay}</span>
                    </div>
                </td>
                <td class="py-3 px-3 ${statusBgClass}">${statusContent}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    function updateView(studentData) {
        let displayedStudents = [...studentData];
        
        // Apply search filter
        const searchTerm = searchInput.value.toLowerCase();
        if (searchTerm) {
            displayedStudents = displayedStudents.filter(student => 
                `${student.firstName} ${student.lastName}`.toLowerCase().includes(searchTerm) || 
                student.pen.toLowerCase().includes(searchTerm)
            );
        }

        // Apply status filter
        const selectedStatus = statusFilter.value;
        if (selectedStatus !== 'all') {
            displayedStudents = displayedStudents.filter(student => student.status === selectedStatus);
        }

        // Apply component filter
        const selectedComponent = componentFilter.value;
        if (selectedComponent !== 'all') {
            displayedStudents = displayedStudents.filter(student => student.component === selectedComponent);
        }

        // Sort watched students to top, then apply name sorting
        displayedStudents.sort((a, b) => {
            if (a.watched && !b.watched) return -1;
            if (!a.watched && b.watched) return 1;
            return 0;
        });

        if (sortDirection !== 'none') {
            displayedStudents.sort((a, b) => {
                // Maintain watched students at top
                if (a.watched && !b.watched) return -1;
                if (!a.watched && b.watched) return 1;
                
                const nameA = `${a.lastName} ${a.firstName}`.toLowerCase();
                const nameB = `${b.lastName} ${b.firstName}`.toLowerCase();
                if (nameA < nameB) return sortDirection === 'asc' ? -1 : 1;
                if (nameA > nameB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        renderTable(displayedStudents);
    }

    function handleUnsubmit() {
        const studentId = confirmUnsubmitBtn.dataset.studentId;
        const studentIndex = students.findIndex(s => s.id === studentId);
        if (studentIndex > -1) {
            students[studentIndex].status = 'Ready to Start';
        }
        updateView(students);
        closeUnsubmitModal();
    }
    
    // --- REALTIME SIMULATOR ---
    function startRealtimeSimulator() {
        setInterval(() => {
            updateLastUpdatedTime();
            if (students.length > 0) {
                const randomIndex = Math.floor(Math.random() * students.length);
                const randomStudent = students[randomIndex];
                const statuses = ['writing', 'disconnected', 'offline'];
                const currentStatusIndex = statuses.indexOf(randomStudent.connectionStatus);
                const nextStatus = statuses[(currentStatusIndex + 1) % statuses.length];
                
                students[randomIndex].connectionStatus = nextStatus;
                
                // Update last seen time for offline/disconnected students
                if (nextStatus === 'offline' || nextStatus === 'disconnected') {
                    students[randomIndex].lastSeen = Date.now();
                }
                
                updateView(students);
            }
        }, 3000); // Update every 3 seconds
    }

    // --- EVENT LISTENERS ---
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        updateLastUpdatedTime();
        updateView(students);
        
        const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        schoolDateInfo.textContent = currentDate;
        
        loginPage.classList.add('hidden');
        dashboardPage.classList.remove('hidden');
        startRealtimeSimulator();
    });
    
    searchInput.addEventListener('keyup', () => updateView(students));
    statusFilter.addEventListener('change', () => updateView(students));
    componentFilter.addEventListener('change', () => updateView(students));
    sortByNameBtn.addEventListener('click', () => {
        if (sortDirection === 'none') sortDirection = 'asc';
        else if (sortDirection === 'asc') sortDirection = 'desc';
        else sortDirection = 'none';
        sortIndicator.innerHTML = sortDirection === 'asc' ? '▲' : sortDirection === 'desc' ? '▼' : '◆';
        updateView(students);
    });
    
    tableBody.addEventListener('click', function(e) {
        const unsubmitButton = e.target.closest('.unsubmit-btn');
        if (unsubmitButton && !unsubmitButton.disabled) {
            studentNameUnsubmitModal.textContent = unsubmitButton.dataset.studentName;
            confirmUnsubmitBtn.dataset.studentId = unsubmitButton.dataset.studentId;
            unsubmitModal.classList.remove('hidden');
        }
        
        const studentNameButton = e.target.closest('.student-name-btn');
        if (studentNameButton) {
            const studentId = studentNameButton.dataset.studentId;
            const student = students.find(s => s.id === studentId);
            if (student) {
                document.getElementById('info-pen').textContent = student.pen;
                document.getElementById('info-first-name').textContent = student.firstName;
                document.getElementById('info-last-name').textContent = student.lastName;
                document.getElementById('info-gender').textContent = 'N/A';
                document.getElementById('info-accommodations').textContent = 'N/A';
                document.getElementById('info-notes').textContent = 'N/A';
                document.getElementById('info-assistive-tech').textContent = 'N/A';
                document.getElementById('info-non-participation').textContent = 'N/A';
                studentInfoModal.classList.remove('hidden');
            }
        }
    });

    tableBody.addEventListener('change', function(e) {
        const watchCheckbox = e.target.closest('.watch-checkbox');
        if (watchCheckbox) {
            const studentId = watchCheckbox.dataset.studentId;
            const student = students.find(s => s.id === studentId);
            if (student) {
                student.watched = watchCheckbox.checked;
                updateView(students);
            }
        }
    });

    confirmUnsubmitBtn.addEventListener('click', handleUnsubmit);
    cancelUnsubmitBtn.addEventListener('click', () => unsubmitModal.classList.add('hidden'));
    
    // Add missing modal event listeners
    techSupportBtn.addEventListener('click', () => {
        techSupportModal.classList.remove('hidden');
    });
    dismissSupportModalBtn.addEventListener('click', () => {
        techSupportModal.classList.add('hidden');
    });
    techSupportModal.addEventListener('click', (e) => {
        if (e.target === techSupportModal) techSupportModal.classList.add('hidden');
    });

    messageCentreBtn.addEventListener('click', () => {
        messageCentreModal.classList.remove('hidden');
    });
    dismissMessageModalBtn.addEventListener('click', () => {
        messageCentreModal.classList.add('hidden');
    });
    messageCentreModal.addEventListener('click', (e) => {
        if (e.target === messageCentreModal) messageCentreModal.classList.add('hidden');
    });
    
    okStudentInfoBtn.addEventListener('click', () => {
        studentInfoModal.classList.add('hidden');
    });
    studentInfoModal.addEventListener('click', (e) => {
        if (e.target === studentInfoModal) studentInfoModal.classList.add('hidden');
    });

</script>

</body>
</html>